---
phase: 02-core-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/resources/db/migration/V2__fix_gin_index_for_hybrid_search.sql
  - src/main/java/dev/alexandria/config/EmbeddingConfig.java
  - src/main/java/dev/alexandria/search/SearchRequest.java
  - src/main/java/dev/alexandria/search/SearchResult.java
  - src/main/java/dev/alexandria/search/SearchService.java
autonomous: true

must_haves:
  truths:
    - "EmbeddingStore bean is configured with SearchMode.HYBRID and textSearchConfig english"
    - "GIN index expression matches LangChain4j coalesce pattern so keyword search uses the index"
    - "SearchService accepts a query string and maxResults, returns SearchResult list with citation metadata"
    - "SearchRequest validates input (non-blank query, maxResults >= 1) and defaults maxResults to 10"
  artifacts:
    - path: "src/main/resources/db/migration/V2__fix_gin_index_for_hybrid_search.sql"
      provides: "GIN index fix matching LangChain4j hybrid search SQL"
      contains: "coalesce(text, '')"
    - path: "src/main/java/dev/alexandria/config/EmbeddingConfig.java"
      provides: "Hybrid-configured EmbeddingStore bean"
      contains: "SearchMode.HYBRID"
    - path: "src/main/java/dev/alexandria/search/SearchService.java"
      provides: "Search orchestration layer mapping EmbeddingStore results to domain DTOs"
      exports: ["SearchService"]
    - path: "src/main/java/dev/alexandria/search/SearchResult.java"
      provides: "Domain DTO with text, score, sourceUrl, sectionPath"
      exports: ["SearchResult"]
    - path: "src/main/java/dev/alexandria/search/SearchRequest.java"
      provides: "Domain request DTO with query validation and default maxResults"
      exports: ["SearchRequest"]
  key_links:
    - from: "src/main/java/dev/alexandria/search/SearchService.java"
      to: "EmbeddingStore<TextSegment>"
      via: "constructor injection"
      pattern: "embeddingStore\\.search"
    - from: "src/main/java/dev/alexandria/search/SearchService.java"
      to: "EmbeddingModel"
      via: "constructor injection"
      pattern: "embeddingModel\\.embed"
    - from: "src/main/java/dev/alexandria/search/SearchService.java"
      to: "src/main/java/dev/alexandria/search/SearchResult.java"
      via: "maps EmbeddingMatch to SearchResult"
      pattern: "metadata\\.getString.*source_url"
---

<objective>
Implement hybrid search infrastructure: fix GIN index for LangChain4j compatibility, configure EmbeddingStore for hybrid mode, and create SearchService with domain DTOs.

Purpose: This is the production code foundation for Phase 2. The EmbeddingStore must be reconfigured for hybrid search, the GIN index expression must match LangChain4j's SQL, and a SearchService must wrap the store to provide a domain-level search API with citation metadata.

Output: V2 Flyway migration, updated EmbeddingConfig, SearchService, SearchRequest, SearchResult
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-search/02-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
@src/main/java/dev/alexandria/config/EmbeddingConfig.java
@src/main/resources/db/migration/V1__initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: V2 Flyway migration fixing GIN index expression and hybrid EmbeddingStore configuration</name>
  <files>
    src/main/resources/db/migration/V2__fix_gin_index_for_hybrid_search.sql
    src/main/java/dev/alexandria/config/EmbeddingConfig.java
  </files>
  <action>
    1. Create `src/main/resources/db/migration/V2__fix_gin_index_for_hybrid_search.sql`:
       - `DROP INDEX IF EXISTS idx_document_chunks_text_fts;`
       - `CREATE INDEX idx_document_chunks_text_fts ON document_chunks USING gin (to_tsvector('english', coalesce(text, '')));`
       - This fixes the GIN index expression to match LangChain4j's hybrid search SQL which uses `coalesce(text, '')` instead of bare `text`. Without this fix, PostgreSQL will sequential-scan instead of using the index for keyword search.

    2. Update `src/main/java/dev/alexandria/config/EmbeddingConfig.java`:
       - Add three builder calls to the `embeddingStore` bean:
         - `.searchMode(SearchMode.HYBRID)` -- enables hybrid vector+keyword search with RRF fusion
         - `.textSearchConfig("english")` -- must match the GIN index text search config; enables English stemming (e.g., "configuring" matches "configure")
         - `.rrfK(60)` -- RRF constant (standard default from the original RRF paper)
       - Add import for `dev.langchain4j.store.embedding.pgvector.SearchMode`
       - Keep all existing builder calls unchanged (datasource, table, dimension, createTable, useIndex)

    NOTE: The searchMode controls which SQL query LangChain4j generates. With HYBRID mode, when both `queryEmbedding` and `query` are provided in EmbeddingSearchRequest, it generates a CTE-based SQL with FULL OUTER JOIN combining vector cosine similarity and ts_rank keyword scores via RRF. When only `queryEmbedding` is provided (query is null), hybrid mode should still work but only produce vector results.
  </action>
  <verify>
    `./gradlew build -x integrationTest -x test` compiles successfully. Verify the V2 migration file exists and contains the coalesce expression. Verify EmbeddingConfig imports SearchMode and uses HYBRID.
  </verify>
  <done>
    GIN index migration uses `coalesce(text, '')` matching LangChain4j SQL. EmbeddingStore bean configured with SearchMode.HYBRID, textSearchConfig "english", rrfK 60.
  </done>
</task>

<task type="auto">
  <name>Task 2: SearchRequest and SearchResult domain DTOs plus SearchService</name>
  <files>
    src/main/java/dev/alexandria/search/SearchRequest.java
    src/main/java/dev/alexandria/search/SearchResult.java
    src/main/java/dev/alexandria/search/SearchService.java
  </files>
  <action>
    1. Create `src/main/java/dev/alexandria/search/SearchRequest.java` as a Java record:
       - Fields: `String query`, `int maxResults`
       - Compact constructor validation: query must not be null or blank (throw IllegalArgumentException "Query must not be blank"), maxResults must be >= 1 (throw IllegalArgumentException "maxResults must be at least 1")
       - Convenience constructor: `SearchRequest(String query)` delegates to canonical with maxResults=10 (SRCH-06 default)

    2. Create `src/main/java/dev/alexandria/search/SearchResult.java` as a Java record:
       - Fields: `String text`, `double score`, `String sourceUrl`, `String sectionPath`
       - No validation needed -- these are output DTOs populated from EmbeddingMatch data
       - SRCH-05: sourceUrl and sectionPath provide citation metadata

    3. Create `src/main/java/dev/alexandria/search/SearchService.java`:
       - `@Service` annotated Spring bean
       - Constructor-injected dependencies: `EmbeddingStore<TextSegment> embeddingStore`, `EmbeddingModel embeddingModel`
       - Public method: `List<SearchResult> search(SearchRequest request)`
         - Embed the query: `embeddingModel.embed(request.query()).content()`
         - Build EmbeddingSearchRequest with:
           - `.queryEmbedding(queryEmbedding)` -- for vector similarity search
           - `.query(request.query())` -- for keyword search in hybrid mode (CRITICAL: without this, hybrid degenerates to vector-only)
           - `.maxResults(request.maxResults())`
         - Call `embeddingStore.search(searchRequest)`
         - Map each `EmbeddingMatch<TextSegment>` to `SearchResult`:
           - `match.embedded().text()` -> text
           - `match.score()` -> score (this is the RRF-combined score in hybrid mode)
           - `match.embedded().metadata().getString("source_url")` -> sourceUrl
           - `match.embedded().metadata().getString("section_path")` -> sectionPath
       - Use consistent metadata key names: "source_url" and "section_path" (snake_case). These MUST match the keys used when storing TextSegments during ingestion. Document this choice in a comment.

    Imports needed in SearchService:
    - `dev.langchain4j.data.embedding.Embedding`
    - `dev.langchain4j.data.segment.TextSegment`
    - `dev.langchain4j.model.embedding.EmbeddingModel`
    - `dev.langchain4j.store.embedding.EmbeddingMatch`
    - `dev.langchain4j.store.embedding.EmbeddingSearchRequest`
    - `dev.langchain4j.store.embedding.EmbeddingSearchResult`
    - `dev.langchain4j.store.embedding.EmbeddingStore`
    - `org.springframework.stereotype.Service`
  </action>
  <verify>
    `./gradlew build -x integrationTest -x test` compiles successfully. Verify all 3 files exist in the search package. Verify SearchService has both embeddingStore.search() and embeddingModel.embed() calls. Verify SearchRequest has default maxResults=10.
  </verify>
  <done>
    SearchRequest record validates input and defaults to 10 results. SearchResult record carries text, score, sourceUrl, sectionPath. SearchService embeds query, delegates to hybrid EmbeddingStore.search(), and maps results extracting citation metadata from TextSegment metadata.
  </done>
</task>

</tasks>

<verification>
- `./gradlew build -x integrationTest` compiles all production code without errors
- V2 migration SQL contains `coalesce(text, '')` in GIN index expression
- EmbeddingConfig has `SearchMode.HYBRID`, `textSearchConfig("english")`, `rrfK(60)`
- SearchService.search() passes both queryEmbedding AND query to EmbeddingSearchRequest
- SearchRequest(query) defaults maxResults to 10
- SearchResult carries sourceUrl and sectionPath fields
</verification>

<success_criteria>
All production code for hybrid search compiles: V2 migration fixes GIN index, EmbeddingStore is HYBRID-configured, SearchService wraps search with citation metadata extraction, and domain DTOs validate input/provide defaults.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-search/02-01-SUMMARY.md`
</output>

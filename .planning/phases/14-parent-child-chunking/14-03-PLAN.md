---
phase: 14-parent-child-chunking
plan: 03
type: tdd
wave: 2
depends_on:
  - 14-01
files_modified:
  - gradle/libs.versions.toml
  - build.gradle
  - src/test/java/dev/alexandria/ingestion/chunking/MarkdownChunkerPropertyTest.java
autonomous: true
requirements:
  - QUAL-04

must_haves:
  truths:
    - "jqwik property tests verify content conservation: no data is lost when chunking (union of all child texts covers all original content blocks)"
    - "jqwik property tests verify size bounds: child chunks respect maxChunkSize (with known exceptions for single-sentence oversized)"
    - "jqwik property tests verify code block balance: every fenced code block in the input appears as exactly one CODE child chunk"
    - "jqwik property tests verify table completeness: tables in the input are preserved intact in child chunks"
    - "jqwik property tests verify parent-child invariant: every child has a parentId and every parentId corresponds to a parent chunk"
  artifacts:
    - path: "gradle/libs.versions.toml"
      provides: "jqwik dependency version"
      contains: "jqwik"
    - path: "build.gradle"
      provides: "jqwik test dependency"
      contains: "jqwik"
    - path: "src/test/java/dev/alexandria/ingestion/chunking/MarkdownChunkerPropertyTest.java"
      provides: "Property-based tests for chunker invariants"
      min_lines: 150
  key_links:
    - from: "MarkdownChunkerPropertyTest"
      to: "MarkdownChunker"
      via: "exercises chunk() with randomly generated Markdown"
      pattern: "chunker.chunk"
    - from: "build.gradle"
      to: "jqwik"
      via: "testImplementation dependency"
      pattern: "jqwik"
---

<objective>
Add jqwik property-based tests for MarkdownChunker structural invariants.

Purpose: Property-based tests catch edge cases that example-based tests miss. Rather than testing specific Markdown inputs, they verify invariants that MUST hold for ALL valid inputs: content conservation, size bounds, code block balance, table completeness, and parent-child structural integrity.

Output: jqwik dependency added, MarkdownChunkerPropertyTest with 5+ property tests and a Markdown arbitrary generator.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-parent-child-chunking/14-CONTEXT.md
@.planning/phases/14-parent-child-chunking/14-01-SUMMARY.md
@src/main/java/dev/alexandria/ingestion/chunking/MarkdownChunker.java
@src/main/java/dev/alexandria/ingestion/chunking/DocumentChunkData.java
@gradle/libs.versions.toml
@build.gradle
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add jqwik dependency to Gradle build</name>
  <files>
    gradle/libs.versions.toml
    build.gradle
  </files>
  <action>
Add jqwik to the project:

1. In `gradle/libs.versions.toml`:
   - Add version: `jqwik = "1.9.2"` (latest stable as of 2026)
   - Add library: `jqwik = { module = "net.jqwik:jqwik", version.ref = "jqwik" }`

2. In `build.gradle`:
   - Add to test dependencies: `testImplementation(libs.jqwik)`
   - jqwik runs on JUnit 5 platform (already configured via `useJUnitPlatform()`)

3. Verify the dependency resolves:
   - Run `./gradlew dependencies --configuration testCompileClasspath | grep jqwik` to confirm resolution
  </action>
  <verify>
`./gradlew dependencies --configuration testCompileClasspath | grep jqwik` shows jqwik 1.9.2 resolved. `./quality.sh test` still passes (no regressions from dependency addition).
  </verify>
  <done>
jqwik 1.9.2 added to libs.versions.toml and build.gradle. Dependency resolves correctly. Existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD property-based tests for chunker invariants</name>
  <files>
    src/test/java/dev/alexandria/ingestion/chunking/MarkdownChunkerPropertyTest.java
  </files>
  <action>
Create `MarkdownChunkerPropertyTest` with a jqwik Markdown arbitrary generator and property tests.

**Markdown Arbitrary Generator:**
Create a `@Provide` method that generates random but structurally valid Markdown documents. The generator should produce documents with:
- 0-5 H2 headings, each with 0-3 H3 sub-headings
- Under each heading: 0-4 prose paragraphs (1-3 sentences each)
- Under each heading: 0-2 fenced code blocks (with random language tags from: java, python, javascript, bash, or no tag)
- Optionally 0-2 GFM tables (2-4 columns, 1-3 data rows)
- Optional preamble content before the first heading
- H4 headings occasionally nested under H3

The generator should use `Arbitraries.of()`, `Arbitraries.strings()`, and combinators to build the Markdown string. Keep it simple enough to be maintainable but rich enough to exercise all chunker paths.

**Property tests (each uses `@Property` annotation):**

1. **`contentConservation`** — For any valid Markdown input, the union of all child chunk texts must contain every non-whitespace content block from the original input. Specifically: every prose paragraph and every code block literal from the input must appear in at least one child chunk. (Parents may contain them too, but children MUST cover all content.)

2. **`childChunksRespectMaxSize`** — Every child chunk of type PROSE has text.length() <= maxChunkSize. Exception: single sentences that exceed maxChunkSize are emitted as-is (this is existing documented behavior). CODE child chunks are exempt (code blocks can be any size).

3. **`codeBlockBalance`** — The number of fenced code blocks in the input equals the number of CODE-type child chunks in the output. Every code block in the input appears as exactly one child chunk.

4. **`tableCompleteness`** — If the input contains a GFM table, the table content (all cell values) must appear intact in a child chunk. No cell data is lost.

5. **`parentChildStructuralIntegrity`** — Every child chunk has a non-null parentId. Every parentId in the output corresponds to exactly one parent chunk with matching sourceUrl and sectionPath. No orphan children. No parent without at least one child (except edge case: section with only a heading and no content produces no chunks at all).

6. **`parentChunkTypeConsistency`** — Every chunk with chunkType="parent" has null parentId. Every chunk with chunkType="child" has non-null parentId.

7. **`sectionPathNeverContainsRawHeadingText`** — sectionPath values are always slugified (lowercase, hyphens, no special characters). This verifies the slugification invariant holds for arbitrary heading text.

**Configuration:**
- Use `@Property(tries = 200)` for a good balance of coverage vs speed
- Use `MarkdownChunker` with default maxChunkSize (2000) for most tests
- Use a smaller maxChunkSize (200) for the `childChunksRespectMaxSize` test to increase split opportunities

**Test class setup:**
- Instantiate `MarkdownChunker` as a field
- Use constants for SOURCE_URL and LAST_UPDATED
  </action>
  <verify>
`./quality.sh test` passes — all 7 property tests run 200 tries each and pass. No test takes > 30 seconds.
  </verify>
  <done>
jqwik property tests verify: content conservation (no data loss), size bounds on prose children, code block count balance, table completeness, parent-child structural integrity, chunk type consistency, sectionPath slugification. All properties pass across 200 random Markdown inputs.
  </done>
</task>

</tasks>

<verification>
1. `./quality.sh test` — all tests pass including 7 new property tests
2. `./quality.sh spotbugs` — no new findings
3. Property test coverage: content conservation, size bounds, code block balance, table completeness, parent-child integrity, type consistency, slugification
4. Generator produces structurally diverse Markdown (headings, code, tables, preamble, nested H4)
5. Each property runs 200 tries in < 30 seconds
</verification>

<success_criteria>
- jqwik dependency added and resolving
- 7 property tests pass across 200+ random Markdown inputs each
- Content conservation: no data lost during chunking
- Size bounds: prose child chunks respect maxChunkSize
- Code blocks: input count equals output CODE child count
- Tables: cell values preserved intact
- Parent-child: every child has valid parentId, every parentId maps to a parent
- All tests complete in reasonable time (< 60s total)
</success_criteria>

<output>
After completion, create `.planning/phases/14-parent-child-chunking/14-03-SUMMARY.md`
</output>

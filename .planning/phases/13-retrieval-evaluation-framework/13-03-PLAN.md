---
phase: 13-retrieval-evaluation-framework
plan: 03
type: execute
wave: 2
depends_on:
  - "13-01"
  - "13-02"
files_modified:
  - src/main/java/dev/alexandria/search/eval/RetrievalEvaluationService.java
  - src/integrationTest/java/dev/alexandria/search/eval/RetrievalEvaluationIT.java
  - build.gradle.kts
autonomous: true
requirements:
  - EVAL-03

must_haves:
  truths:
    - "A JUnit 5 test tagged @Tag('eval') loads the golden set and runs all 100 queries against the live index"
    - "The test computes metrics at k=5, k=10, k=20 for each query using RetrievalMetrics"
    - "The test asserts configurable thresholds (default Recall@10 >= 0.70, MRR >= 0.60)"
    - "On failure, the test generates detailed CSV showing which queries failed"
    - "Metrics are broken down by query type AND global aggregate"
    - "The test is excluded from normal CI builds (only runs with @Tag filter)"
  artifacts:
    - path: "src/main/java/dev/alexandria/search/eval/RetrievalEvaluationService.java"
      provides: "Orchestrates golden set loading, search execution, metric computation, and export"
      contains: "class RetrievalEvaluationService"
    - path: "src/integrationTest/java/dev/alexandria/search/eval/RetrievalEvaluationIT.java"
      provides: "JUnit 5 parameterised evaluation test"
      contains: "@Tag(\"eval\")"
    - path: "build.gradle.kts"
      provides: "Tag exclusion configuration for integrationTest task"
      contains: "eval"
  key_links:
    - from: "src/integrationTest/java/dev/alexandria/search/eval/RetrievalEvaluationIT.java"
      to: "src/main/java/dev/alexandria/search/eval/RetrievalEvaluationService.java"
      via: "Spring-injected service"
      pattern: "@Autowired.*RetrievalEvaluationService"
    - from: "src/main/java/dev/alexandria/search/eval/RetrievalEvaluationService.java"
      to: "src/main/java/dev/alexandria/search/SearchService.java"
      via: "Constructor injection for search execution"
      pattern: "SearchService"
    - from: "src/main/java/dev/alexandria/search/eval/RetrievalEvaluationService.java"
      to: "src/main/java/dev/alexandria/search/eval/RetrievalMetrics.java"
      via: "Static method calls for metric computation"
      pattern: "RetrievalMetrics\\."
    - from: "src/main/java/dev/alexandria/search/eval/RetrievalEvaluationService.java"
      to: "src/main/java/dev/alexandria/search/eval/EvaluationExporter.java"
      via: "Constructor injection for CSV export"
      pattern: "EvaluationExporter"
    - from: "build.gradle.kts"
      to: "src/integrationTest/java/dev/alexandria/search/eval/RetrievalEvaluationIT.java"
      via: "excludeTags configuration"
      pattern: "excludeTags.*eval"
---

<objective>
Wire the evaluation framework end-to-end: create the orchestration service that runs queries against the live index, computes metrics, and exports results. Create the JUnit 5 integration test that validates thresholds.

Purpose: This is the final integration layer that ties RetrievalMetrics (plan 01), golden set + exporter (plan 02), and the live SearchService together. The test will serve as the baseline measurement gate for phases 14-18.

Output: RetrievalEvaluationService, RetrievalEvaluationIT integration test, build config excluding @Tag("eval") from normal runs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-retrieval-evaluation-framework/13-01-SUMMARY.md
@.planning/phases/13-retrieval-evaluation-framework/13-02-SUMMARY.md
@src/main/java/dev/alexandria/search/SearchService.java
@src/main/java/dev/alexandria/search/SearchRequest.java
@src/main/java/dev/alexandria/search/SearchResult.java
@src/integrationTest/java/dev/alexandria/BaseIntegrationTest.java
@build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RetrievalEvaluationService and integration test</name>
  <files>
    src/main/java/dev/alexandria/search/eval/RetrievalEvaluationService.java
    src/integrationTest/java/dev/alexandria/search/eval/RetrievalEvaluationIT.java
  </files>
  <action>
    **RetrievalEvaluationService** Spring @Service:
    - Constructor-injected dependencies: `SearchService`, `EvaluationExporter`, `ObjectMapper`
    - `@Value("${alexandria.eval.thresholds.recall-at-10:0.70}")` for recall threshold
    - `@Value("${alexandria.eval.thresholds.mrr:0.60}")` for MRR threshold

    **Core method `evaluate(String label)`:**
    1. Load golden-set.json from classpath (`classpath:eval/golden-set.json`) via ObjectMapper
    2. For each GoldenSetEntry:
       a. Execute `searchService.search(new SearchRequest(entry.query(), 20))` (k=20 is max depth needed)
       b. Extract chunk identifiers from SearchResult. The chunk ID for matching is constructed from `sourceUrl + "#" + sectionPath` (matching the chunkId format in the golden set). If no exact match is found, fall back to substring matching on the section_path.
       c. Compute all metrics at k=5, k=10, k=20 using RetrievalMetrics static methods
       d. Build EvaluationResult with ChunkResult entries (chunk_id, score, rank, relevance_grade from judgments)
    3. Call `evaluationExporter.export(results, label)` to write CSVs
    4. Return an `EvaluationSummary` record with:
       - Global averages: recallAt10, mrr, ndcgAt10, mapScore, hitRateAt10
       - Per-type averages: Map<QueryType, MetricsSummary>
       - Pass/fail status based on configured thresholds
       - List of failed queries (below threshold)

    **EvaluationSummary** (inner record or separate file):
    ```java
    public record EvaluationSummary(
        double globalRecallAt10,
        double globalMrr,
        double globalNdcgAt10,
        double globalMap,
        double globalHitRateAt10,
        Map<QueryType, TypeMetrics> byType,
        boolean passed,
        List<String> failedQueries
    ) {
        public record TypeMetrics(int count, double recallAt10, double mrr, double ndcgAt10) {}
    }
    ```

    **RetrievalEvaluationIT** integration test:
    - Extends `BaseIntegrationTest` (gets Testcontainers PostgreSQL)
    - `@Tag("eval")` on the class — this is the key tag for exclusion
    - `@Autowired RetrievalEvaluationService evaluationService`

    **Test structure:**
    ```java
    @Tag("eval")
    class RetrievalEvaluationIT extends BaseIntegrationTest {

        @Autowired RetrievalEvaluationService evaluationService;

        @Test
        void goldenSetMeetsMinimumRetrievalQuality() {
            // This test requires a populated index with Spring Boot documentation.
            // It will fail if the index is empty (expected — the test is meant to run
            // against a real deployment with indexed Spring Boot docs).

            EvaluationSummary summary = evaluationService.evaluate("baseline");

            // Assert configurable thresholds
            assertThat(summary.globalRecallAt10())
                .as("Global Recall@10 should meet minimum threshold")
                .isGreaterThanOrEqualTo(0.70);

            assertThat(summary.globalMrr())
                .as("Global MRR should meet minimum threshold")
                .isGreaterThanOrEqualTo(0.60);

            // Log per-type breakdown for visibility
            summary.byType().forEach((type, metrics) ->
                log.info("Type {}: recall@10={}, mrr={}, ndcg@10={} (n={})",
                    type, metrics.recallAt10(), metrics.mrr(), metrics.ndcgAt10(), metrics.count()));
        }
    }
    ```

    **Important:** The test is designed to run against a fully populated index. When running against an empty Testcontainers database, it will fail (which is expected). The real value is running it against a deployment with indexed Spring Boot docs. The test uses @Tag("eval") so it never runs in normal CI.

    **Chunk ID matching strategy:**
    The golden set uses semantic path IDs like `spring-boot/web/rest-controllers#creating-rest-controller`. The search returns `sourceUrl` and `sectionPath`. The matching logic in RetrievalEvaluationService should:
    1. For each SearchResult, construct a candidate ID from its metadata
    2. Check if the golden set judgment chunkId is a substring of the candidate (or vice versa)
    3. This fuzzy matching accommodates the fact that exact chunk boundaries may differ from the golden set's idealized identifiers
  </action>
  <verify>
    - `./gradlew compileJava compileIntegrationTestJava` passes (compilation only — the test itself needs a populated index)
    - `./gradlew spotlessApply` passes
    - RetrievalEvaluationIT has @Tag("eval") annotation
    - RetrievalEvaluationService loads golden-set.json and uses SearchService, RetrievalMetrics, EvaluationExporter
  </verify>
  <done>
    RetrievalEvaluationService orchestrates golden set evaluation end-to-end, and RetrievalEvaluationIT is tagged for on-demand execution with configurable thresholds
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure build to exclude @Tag("eval") from normal test runs</name>
  <files>
    build.gradle.kts
  </files>
  <action>
    Modify the `integrationTest` suite configuration in `build.gradle.kts` to exclude the "eval" tag from normal runs.

    In the existing `testing { suites { ... } }` block, add tag exclusion to the integrationTest task configuration:

    ```kotlin
    testTask.configure {
        shouldRunAfter(test)
        systemProperty("api.version", "1.44")
        // Exclude evaluation tests from normal CI runs.
        // Run them explicitly: ./gradlew integrationTest -PincludeEvalTag
        useJUnitPlatform {
            excludeTags("eval")
        }
    }
    ```

    Also add a Gradle property to optionally include eval tests:
    ```kotlin
    // Allow running eval tests explicitly
    if (project.hasProperty("includeEvalTag")) {
        useJUnitPlatform {
            // No excludeTags — run everything including eval
        }
    } else {
        useJUnitPlatform {
            excludeTags("eval")
        }
    }
    ```

    This way:
    - `./gradlew integrationTest` — runs all integration tests EXCEPT @Tag("eval")
    - `./gradlew integrationTest -PincludeEvalTag` — runs ALL integration tests including eval
    - The eval test does NOT appear in normal CI

    **Also ensure** the integrationTest source set has access to Jackson (ObjectMapper) for golden set deserialization. Check if `spring-boot-starter-web` (which includes Jackson) is already available via `implementation(project())`. If not, add `implementation(libs.spring.boot.starter.web)` to the integrationTest dependencies. The existing `implementation(project())` should already pull in all main dependencies including Jackson, so this is likely not needed — verify compilation.
  </action>
  <verify>
    - `./gradlew integrationTest` runs WITHOUT executing RetrievalEvaluationIT (check test count or output)
    - `./gradlew compileIntegrationTestJava` compiles the eval test successfully
    - `./gradlew spotlessApply && ./gradlew compileJava` passes
  </verify>
  <done>
    @Tag("eval") tests are excluded from normal integrationTest runs and can be included via -PincludeEvalTag flag
  </done>
</task>

</tasks>

<verification>
- `./gradlew compileJava compileIntegrationTestJava` passes (full compilation)
- `./gradlew integrationTest` runs without eval tests
- `./gradlew test` passes (unit tests unaffected)
- `./gradlew spotlessApply && ./gradlew compileJava` passes
- RetrievalEvaluationService loads golden set, calls SearchService, computes metrics, exports CSV
</verification>

<success_criteria>
- RetrievalEvaluationService orchestrates the full evaluation pipeline: load -> search -> compute -> export
- JUnit 5 integration test is tagged @Tag("eval") and excluded from normal CI
- Configurable thresholds (Recall@10 >= 0.70, MRR >= 0.60) drive pass/fail
- On failure, detailed CSV is generated for diagnosis
- Build config supports -PincludeEvalTag for on-demand execution
</success_criteria>

<output>
After completion, create `.planning/phases/13-retrieval-evaluation-framework/13-03-SUMMARY.md`
</output>

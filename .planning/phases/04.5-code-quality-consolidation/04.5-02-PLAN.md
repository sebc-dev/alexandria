---
phase: 04.5-code-quality-consolidation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/dev/alexandria/ingestion/chunking/MarkdownChunker.java
  - src/test/java/dev/alexandria/ingestion/chunking/MarkdownChunkerTest.java
  - src/test/java/dev/alexandria/ingestion/chunking/LanguageDetectorTest.java
requirements: []
autonomous: true

must_haves:
  truths:
    - "All 19 surviving PIT mutations in MarkdownChunker are killed or justified"
    - "The 1 surviving PIT mutation in LanguageDetector is killed"
    - "MarkdownChunker.chunk() and emitChunks() are each under 25 lines after refactoring"
    - "All existing MarkdownChunkerTest and LanguageDetectorTest tests still pass"
  artifacts:
    - path: "src/test/java/dev/alexandria/ingestion/chunking/MarkdownChunkerTest.java"
      provides: "Expanded tests killing PIT mutations in appendNodeText, emitChunks, splitOversizedText, splitBySentences"
    - path: "src/main/java/dev/alexandria/ingestion/chunking/MarkdownChunker.java"
      provides: "Refactored chunk() and emitChunks() methods with extracted helper methods"
  key_links:
    - from: "MarkdownChunkerTest"
      to: "MarkdownChunker"
      via: "boundary tests targeting specific mutation locations"
      pattern: "assertThat.*chunk"
---

<objective>
Kill all 20 surviving PIT mutations and refactor MarkdownChunker's two longest methods into smaller, well-named units.

Purpose: Strengthen the most complex code path (Markdown chunking) with mutation-proof tests, then improve readability via method extraction.
Output: Zero surviving mutations (or documented justifications), MarkdownChunker methods all under 25 lines.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.5-code-quality-consolidation/04.5-RESEARCH.md
@src/main/java/dev/alexandria/ingestion/chunking/MarkdownChunker.java
@src/test/java/dev/alexandria/ingestion/chunking/MarkdownChunkerTest.java
@src/test/java/dev/alexandria/ingestion/chunking/LanguageDetectorTest.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Kill all surviving PIT mutations in MarkdownChunker and LanguageDetector</name>
  <files>
    src/test/java/dev/alexandria/ingestion/chunking/MarkdownChunkerTest.java
    src/test/java/dev/alexandria/ingestion/chunking/LanguageDetectorTest.java
  </files>
  <action>
    **Step 1: Run PIT to get current mutation baseline:**
    ```bash
    ./quality.sh mutation --package dev.alexandria.ingestion.chunking
    ```
    Read the HTML report at `build/reports/pitest/index.html` to identify exact mutation locations.

    **Step 2: Write targeted tests to kill each surviving mutation.**

    The 19 surviving mutations in MarkdownChunker are concentrated in:
    - `appendNodeText()` -- text accumulation logic, boundary conditions around whitespace and node types
    - `emitChunks()` -- conditional logic for prose vs code chunks, oversized splitting threshold
    - `splitOversizedText()` -- paragraph boundary splitting, fallback to sentence splitting
    - `splitBySentences()` -- sentence boundary regex, minimum chunk size

    For each mutation, write a test that:
    1. Targets the specific conditional or boundary the mutation affects
    2. Has an assertion that fails when the mutation is applied
    3. Follows camelCase naming convention (per user decision)
    4. Tests observable behavior, not implementation details

    **Step 3: Kill the 1 surviving LanguageDetector mutation.**
    Add a targeted test to LanguageDetectorTest (already camelCase, no rename needed).

    **Step 4: Re-run PIT and verify all mutations killed.**
    ```bash
    ./quality.sh mutation --package dev.alexandria.ingestion.chunking
    ```
    If any mutation genuinely cannot be killed without testing implementation details, document WHY in a code comment near the test.
  </action>
  <verify>
    `./quality.sh mutation --package dev.alexandria.ingestion.chunking` shows 100% mutation score (or documents surviving mutations with justification). `./quality.sh test` passes all tests.
  </verify>
  <done>All 20 previously surviving mutations are killed or have documented justifications. PIT mutation score for ingestion/chunking is 95%+ (allowing for any justified survivors).</done>
</task>

<task type="auto">
  <name>Task 2: Refactor MarkdownChunker long methods (chunk, emitChunks)</name>
  <files>
    src/main/java/dev/alexandria/ingestion/chunking/MarkdownChunker.java
  </files>
  <action>
    Per user decision: refactoring is **pragmatic based on readability**, not a strict line limit. Methods doing multiple distinct things should be decomposed. Linear flows can remain even if >30 lines.

    **Refactor chunk() (~33 lines, lines 63-112):**
    The while-loop body handles heading tracking, content accumulation, and code block collection as three distinct concerns. Extract:
    - `processNode(Node node)` -- dispatches to heading/code/content handlers
    - Or extract the body of the while-loop handling Heading/FencedCodeBlock/other into named private methods

    **Refactor emitChunks() (~40 lines, lines 114-154):**
    Two distinct responsibilities: emit prose chunk (with oversized splitting) and emit code chunks. Split into:
    - `emitProseChunk(...)` -- handles prose text assembly, oversized splitting, and adding to results
    - `emitCodeChunks(...)` -- handles code chunk assembly and adding to results

    **Do NOT refactor:**
    - `splitOversizedText()` (~38 lines) -- single responsibility, linear flow per user decision "tolerate if the flow is linear and readable"
    - `splitBySentences()` -- same reasoning

    After refactoring, verify all existing tests still pass:
    ```bash
    ./quality.sh test
    ```

    Then re-run PIT to confirm mutation score did not regress:
    ```bash
    ./quality.sh mutation --package dev.alexandria.ingestion.chunking
    ```
  </action>
  <verify>
    `./quality.sh test` passes. `./quality.sh mutation --package dev.alexandria.ingestion.chunking` shows no regression from pre-refactoring score. Main methods (chunk, emitChunks) each under 25 lines. Extracted methods have descriptive names.
  </verify>
  <done>MarkdownChunker.chunk() and emitChunks() refactored into smaller methods. All tests pass. PIT mutation score maintained or improved.</done>
</task>

</tasks>

<verification>
- `./quality.sh test` passes all unit tests (no regressions)
- `./quality.sh mutation --package dev.alexandria.ingestion.chunking` shows 95%+ mutation score
- MarkdownChunker has no method over 25 lines (chunk, emitChunks, extracted methods)
- LanguageDetector mutation killed
</verification>

<success_criteria>
PIT mutation score for ingestion/chunking package improved from 51% to 95%+. MarkdownChunker refactored for readability with all tests green.
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-code-quality-consolidation/04.5-02-SUMMARY.md`
</output>

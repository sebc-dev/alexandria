---
phase: 04.5-code-quality-consolidation
plan: 03
subsystem: testing
tags: [mockito, restclient, crawl4ai, sitemap, unit-tests, refactoring]

# Dependency graph
requires:
  - phase: 03-web-crawling
    provides: CrawlService, Crawl4AiClient, PageDiscoveryService, SitemapParser implementations
  - phase: 04.5-01
    provides: SpotBugs exclusions, record defensive copies
provides:
  - Unit tests for CrawlService (10 tests)
  - Unit tests for PageDiscoveryService (6 tests)
  - Unit tests for Crawl4AiClient (10 tests)
  - Unit tests for SitemapParser (10 tests)
  - CrawlService.crawlSite() refactored into 4 smaller methods
affects: [04.5-04, 04.5-05]

# Tech tracking
tech-stack:
  added: []
  patterns: [RestClient mock chain with answer-based URI routing, LinkedHashSet BFS queue pattern]

key-files:
  created:
    - src/test/java/dev/alexandria/crawl/CrawlServiceTest.java
    - src/test/java/dev/alexandria/crawl/PageDiscoveryServiceTest.java
    - src/test/java/dev/alexandria/crawl/Crawl4AiClientTest.java
    - src/test/java/dev/alexandria/crawl/SitemapParserTest.java
  modified:
    - src/main/java/dev/alexandria/crawl/CrawlService.java

key-decisions:
  - "RestClient mock chain uses answer-based URI routing (per-URL mock specs) to handle multi-URL tests cleanly"
  - "CrawlService.crawlSite() refactored from ~50 to ~22 lines by extracting seedQueue, dequeueAndNormalize, processPage, enqueueDiscoveredLinks"

patterns-established:
  - "Answer-based Mockito stubs for RestClient.Builder/RestClient chains with multiple URLs"

requirements-completed: []

# Metrics
duration: 5min
completed: 2026-02-19
---

# Phase 04.5 Plan 03: Crawl Package Unit Tests Summary

**4 new unit test classes (36 tests) covering CrawlService, Crawl4AiClient, PageDiscoveryService, SitemapParser + CrawlService.crawlSite() refactored to ~22 lines**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-19T19:32:48Z
- **Completed:** 2026-02-19T19:38:09Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Crawl package goes from 1 unit test class (UrlNormalizerTest, 11 tests) to 5 classes (47 tests)
- CrawlServiceTest covers happy path, BFS link following, sitemap mode, maxPages limit, error handling, URL deduplication, normalization, external link filtering
- Crawl4AiClientTest covers success, fit/raw markdown fallback, error responses, null/empty handling, RestClientException
- SitemapParserTest covers valid sitemaps, sitemap index, fallback candidates, malformed XML, normalizeToBase
- PageDiscoveryServiceTest covers sitemap-first strategy, link-crawl fallback, external URL filtering, deduplication
- CrawlService.crawlSite() refactored from ~50 lines to ~22 lines with 4 extracted methods

## Task Commits

Each task was committed atomically:

1. **Task 1: Add unit tests for CrawlService and PageDiscoveryService** - `706ee9e` (test)
2. **Task 2: Add Crawl4AiClient/SitemapParser tests, refactor CrawlService** - `c99445a` (feat)

## Files Created/Modified
- `src/test/java/dev/alexandria/crawl/CrawlServiceTest.java` - 10 tests covering orchestrator behavior with mocked Crawl4AiClient and PageDiscoveryService
- `src/test/java/dev/alexandria/crawl/PageDiscoveryServiceTest.java` - 6 tests covering sitemap-first discovery strategy with mocked SitemapParser
- `src/test/java/dev/alexandria/crawl/Crawl4AiClientTest.java` - 10 tests covering REST client interaction with mocked RestClient chain
- `src/test/java/dev/alexandria/crawl/SitemapParserTest.java` - 10 tests covering sitemap XML parsing with answer-based URI routing mocks
- `src/main/java/dev/alexandria/crawl/CrawlService.java` - Refactored crawlSite() into seedQueue, dequeueAndNormalize, processPage, enqueueDiscoveredLinks

## Decisions Made
- Used answer-based Mockito stubs for SitemapParser's RestClient.Builder chain to handle multi-URL test scenarios cleanly without mock conflicts
- CrawlService refactoring kept pragmatic: extracted 4 private methods, each with a single responsibility, without changing the public API

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed SitemapParserTest mock conflicts with answer-based routing**
- **Found during:** Task 2
- **Issue:** Initial SitemapParserTest used shared mock instances for `RequestHeadersSpec` and `ResponseSpec` across multiple URLs, causing UnnecessaryStubbingException and wrong behavior when multiple URLs were stubbed
- **Fix:** Switched to answer-based `when(...).thenAnswer(...)` on `requestHeadersUriSpec.uri(anyString())` that creates per-URL mock chains from a HashMap registry
- **Files modified:** src/test/java/dev/alexandria/crawl/SitemapParserTest.java
- **Verification:** All 129 tests pass
- **Committed in:** c99445a (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Fix was necessary for test correctness. No scope creep.

## Issues Encountered
None beyond the mock conflict addressed above.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Crawl package fully unit-tested, ready for mutation testing analysis in plan 04.5-04 or 04.5-05
- All quality gates pass (129 unit tests, 0 failures)

## Self-Check: PASSED

All 5 files verified present. Both commit hashes (706ee9e, c99445a) confirmed in git log.

---
*Phase: 04.5-code-quality-consolidation*
*Completed: 2026-02-19*

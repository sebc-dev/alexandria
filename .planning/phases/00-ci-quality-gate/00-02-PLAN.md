---
phase: 00-ci-quality-gate
plan: 02
type: execute
wave: 2
depends_on: ["00-01"]
files_modified:
  - quality.sh
  - .github/workflows/ci.yml
autonomous: false
user_setup:
  - service: sonarcloud
    why: "Quality dashboard and PR comment integration"
    env_vars:
      - name: SONAR_TOKEN
        source: "SonarCloud -> My Account -> Security -> Generate Token"
    account_setup:
      - "Create SonarCloud account at https://sonarcloud.io (free for open-source)"
      - "Import the Alexandria GitHub repository into SonarCloud"
      - "Note the organization key and project key for build.gradle.kts sonar config"
    dashboard_config:
      - task: "Create custom Quality Gate (non-blocking coverage)"
        location: "SonarCloud -> Organization -> Quality Gates -> Create"
        details: "Remove 'Coverage on New Code >= 80%' condition from Sonar way defaults. Keep Security/Reliability/Maintainability ratings on new code >= A. Set Duplicated Lines on New Code <= 10%."
    github_config:
      - task: "Add SONAR_TOKEN repository secret"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> New repository secret"
        details: "Name: SONAR_TOKEN, Value: token from SonarCloud"

must_haves:
  truths:
    - "./quality.sh test runs unit tests and prints a concise text summary"
    - "./quality.sh mutation runs PIT and prints a concise mutation score summary"
    - "./quality.sh spotbugs runs SpotBugs and prints a concise bug count summary"
    - "./quality.sh arch runs ArchUnit tests and prints pass/fail summary"
    - "./quality.sh coverage generates JaCoCo report and prints coverage percentages"
    - "./quality.sh all runs all quality gates sequentially and prints combined summary"
    - "./quality.sh test --package dev.alexandria targets a specific package"
    - "GitHub Actions CI workflow runs parallel jobs on push to main and PR targeting main"
    - "CI test job blocks merge on test failure"
    - "CI spotbugs, mutation, sonarcloud jobs run in parallel and do not block merge"
    - "CI jobs publish HTML report artifacts (JaCoCo, PIT, SpotBugs) downloadable from GitHub"
  artifacts:
    - path: "quality.sh"
      provides: "Local quality gate runner with subcommands for Claude Code"
      contains: "quality.sh"
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI pipeline with parallel quality gate jobs"
      contains: "pitest"
  key_links:
    - from: "quality.sh"
      to: "build.gradle.kts"
      via: "Invokes Gradle tasks (test, pitest, spotbugsMain, jacocoTestReport)"
      pattern: "gradlew"
    - from: ".github/workflows/ci.yml"
      to: "build.gradle.kts"
      via: "CI jobs invoke same Gradle tasks as local quality.sh"
      pattern: "gradlew"
    - from: ".github/workflows/ci.yml"
      to: "SonarCloud"
      via: "sonar task sends analysis results using SONAR_TOKEN secret"
      pattern: "SONAR_TOKEN"
---

<objective>
Create the local quality script (quality.sh) for Claude Code and the GitHub Actions CI pipeline with parallel quality gate jobs and SonarCloud integration.

Purpose: quality.sh gives Claude Code a fast, token-efficient way to run targeted quality checks locally. The GitHub Actions workflow ensures the same gates run automatically on every push/PR, with only test failures blocking merge. SonarCloud provides the central quality dashboard with PR comments.
Output: quality.sh executable script, .github/workflows/ci.yml workflow file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-ci-quality-gate/00-CONTEXT.md
@.planning/phases/00-ci-quality-gate/00-RESEARCH.md
@.planning/phases/00-ci-quality-gate/00-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quality.sh local quality gate script</name>
  <files>quality.sh</files>
  <action>
    Create `quality.sh` at project root. Make it executable (`chmod +x quality.sh`).

    Script requirements (per user decisions):
    - Subcommands: test, mutation, spotbugs, arch, coverage, all, help
    - Package targeting: `--package <pkg>` argument supported for test, mutation
    - Concise text output: After each Gradle task, parse results and print a short summary
    - Use `./gradlew --console=plain --no-daemon` as the base Gradle invocation

    Implementation details:

    **Header:**
    ```
    #!/usr/bin/env bash
    set -euo pipefail
    ```

    **Argument parsing:**
    - COMMAND = $1 (default: help)
    - Parse --package flag into PACKAGE variable

    **Subcommand: test**
    - If PACKAGE set: `./gradlew test --tests "${PACKAGE}.*" --console=plain --no-daemon`
    - Else: `./gradlew test --console=plain --no-daemon`
    - After completion, parse the JUnit XML results from build/test-results/test/ to extract: total tests, passed, failed, skipped
    - Print summary: "TESTS: X passed, Y failed, Z skipped (total: N)"

    **Subcommand: mutation**
    - If PACKAGE set: pass `-Ppitest.targetClasses=${PACKAGE}.*` to Gradle
    - Else: `./gradlew pitest --console=plain --no-daemon`
    - After completion, parse build/reports/pitest/mutations.xml (or the HTML index) for: total mutations, killed, survived, mutation score percentage
    - Print summary: "MUTATIONS: X killed / Y total (Z% mutation score)"

    **Subcommand: spotbugs**
    - `./gradlew spotbugsMain --console=plain --no-daemon`
    - Parse build/reports/spotbugs/ XML for bug count by category
    - Print summary: "SPOTBUGS: X bugs found (Y high, Z medium)"

    **Subcommand: arch**
    - `./gradlew test --tests "dev.alexandria.architecture.*" --console=plain --no-daemon`
    - Print summary: "ARCHITECTURE TESTS: PASSED" or "FAILED" based on exit code

    **Subcommand: coverage**
    - `./gradlew test jacocoTestReport --console=plain --no-daemon`
    - Parse build/reports/jacoco/test/jacocoTestReport.xml for line and branch coverage percentages
    - Print summary: "COVERAGE: X% line, Y% branch"

    **Subcommand: all**
    - Run: test, then jacocoTestReport, then spotbugsMain, then pitest, then arch tests
    - Use `./gradlew test jacocoTestReport spotbugsMain --console=plain --no-daemon` for the parallelizable gates
    - Then `./gradlew pitest --console=plain --no-daemon` separately (PIT is heavy)
    - Then arch tests
    - Print combined summary of all gates

    **Subcommand: help**
    - Print usage with all commands and --package option documented

    **Output formatting guidelines:**
    - Use "---" separator between Gradle output and summary
    - Summary lines prefixed with emoji-free labels (TESTS:, MUTATIONS:, etc.)
    - Keep summary under 5 lines per gate -- this is what Claude Code reads to save tokens
    - If a gate fails to produce parseable output, print "SUMMARY: Could not parse report. Check build/reports/ for details."

    **XML parsing approach:**
    - Use grep/awk/sed for lightweight XML extraction (no external dependencies)
    - JaCoCo XML: grep for `<counter type="LINE"` and `<counter type="BRANCH"` elements, extract missed/covered attributes
    - JUnit XML: count `<testcase` elements and `<failure` elements
    - SpotBugs XML: count `<BugInstance` elements
    - PIT XML: count mutation elements with status attributes

    Verify: `./quality.sh test` runs and prints summary. `./quality.sh help` prints usage.
  </action>
  <verify>
    ./quality.sh help prints usage with all subcommands listed.
    ./quality.sh test runs unit tests and prints a summary line with pass/fail counts.
    ./quality.sh coverage runs and prints coverage percentages.
    ./quality.sh mutation runs PIT and prints mutation score.
    ./quality.sh spotbugs runs and prints bug count.
    ./quality.sh arch runs and prints pass/fail.
    ./quality.sh all runs all gates and prints combined summary.
    ./quality.sh test --package dev.alexandria targets the package correctly.
  </verify>
  <done>
    quality.sh is executable, supports all 7 subcommands (test, mutation, spotbugs, arch, coverage, all, help), supports --package targeting, and prints concise text summaries parseable by Claude Code without reading HTML reports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow with parallel jobs</name>
  <files>.github/workflows/ci.yml</files>
  <action>
    Create `.github/workflows/ci.yml` with these exact specifications per user decisions:

    **Workflow name:** CI Quality Gate
    **Triggers:** push to main, pull_request targeting main

    **Jobs (all parallel except where noted):**

    **Job: test** (BLOCKING -- this is what blocks merge)
    - runs-on: ubuntu-latest
    - Steps:
      1. actions/checkout@v4
      2. actions/setup-java@v4 (distribution: temurin, java-version: 21)
      3. gradle/actions/setup-gradle@v5
      4. Run: `./gradlew test --console=plain`
      5. Run: `./gradlew integrationTest --console=plain`
      6. actions/upload-artifact@v4 (if: always(), name: test-results, path: build/reports/tests/)

    **Job: coverage** (parallel, non-blocking)
    - runs-on: ubuntu-latest
    - continue-on-error: true
    - Steps:
      1. actions/checkout@v4
      2. actions/setup-java@v4 (temurin, 21)
      3. gradle/actions/setup-gradle@v5
      4. Run: `./gradlew test jacocoTestReport --console=plain`
      5. actions/upload-artifact@v4 (name: coverage-report, path: build/reports/jacoco/)

    **Job: spotbugs** (parallel, non-blocking)
    - runs-on: ubuntu-latest
    - continue-on-error: true
    - Steps:
      1. actions/checkout@v4
      2. actions/setup-java@v4 (temurin, 21)
      3. gradle/actions/setup-gradle@v5
      4. Run: `./gradlew spotbugsMain --console=plain`
      5. actions/upload-artifact@v4 (if: always(), name: spotbugs-report, path: build/reports/spotbugs/)

    **Job: mutation** (parallel, non-blocking)
    - runs-on: ubuntu-latest
    - continue-on-error: true
    - Steps:
      1. actions/checkout@v4
      2. actions/setup-java@v4 (temurin, 21)
      3. gradle/actions/setup-gradle@v5
      4. Run: `./gradlew pitest --console=plain`
      5. actions/upload-artifact@v4 (if: always(), name: pit-report, path: build/reports/pitest/)

    **Job: sonarcloud** (parallel, non-blocking)
    - runs-on: ubuntu-latest
    - continue-on-error: true
    - Steps:
      1. actions/checkout@v4 with fetch-depth: 0 (CRITICAL: SonarCloud needs full git history for blame analysis)
      2. actions/setup-java@v4 (temurin, 21)
      3. gradle/actions/setup-gradle@v5
      4. Run: `./gradlew test jacocoTestReport sonar --info --console=plain`
         env: SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}, GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    **Important notes:**
    - Do NOT use `continue-on-error: true` on the test job. Test failures MUST block merge.
    - All other jobs (coverage, spotbugs, mutation, sonarcloud) MUST have `continue-on-error: true` so they report results without blocking.
    - The `GITHUB_TOKEN` is auto-provided by GitHub Actions (no manual secret needed for it).
    - gradle/actions/setup-gradle@v5 handles all caching automatically (no manual actions/cache needed).

    After creating ci.yml, verify its YAML syntax is valid.
  </action>
  <verify>
    .github/workflows/ci.yml exists and is valid YAML (check with: python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))").
    Workflow has exactly 5 jobs: test, coverage, spotbugs, mutation, sonarcloud.
    Only the test job does NOT have continue-on-error: true.
    All jobs use gradle/actions/setup-gradle@v5 (not the deprecated gradle-build-action).
    Triggers are: push branches [main], pull_request branches [main].
    sonarcloud job has fetch-depth: 0 in checkout step.
  </verify>
  <done>
    GitHub Actions CI workflow runs 5 parallel jobs on push/PR to main. Test failures block merge. SpotBugs, PIT, coverage, and SonarCloud run as non-blocking analysis jobs. All jobs publish HTML report artifacts. SonarCloud integration is configured (requires SONAR_TOKEN secret to be set by user).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify CI pipeline end-to-end</name>
  <files>quality.sh, .github/workflows/ci.yml</files>
  <action>
    Present the completed CI quality infrastructure to the user for verification. All automation is complete at this point -- this checkpoint confirms correctness before the phase is marked done.
  </action>
  <verify>
    User confirms the following:
    1. `./quality.sh all` runs locally and produces concise summaries for all gates
    2. `./quality.sh test --package dev.alexandria` correctly targets a package
    3. `.github/workflows/ci.yml` has 5 parallel jobs with correct blocking/non-blocking configuration
    4. SonarCloud setup steps are clear (user_setup in frontmatter)
  </verify>
  <done>
    User has approved the CI pipeline configuration. Phase 0 quality infrastructure is complete and ready for use in all subsequent phases.
  </done>
</task>

</tasks>

<verification>
End-to-end quality pipeline verification:

1. Local: `./quality.sh all` runs all gates and prints summaries
2. Local: `./gradlew check` runs unit tests + integration tests + all wired quality gates
3. CI: `.github/workflows/ci.yml` is syntactically valid YAML
4. CI: Workflow defines 5 parallel jobs with correct triggers
5. Script: `./quality.sh help` documents all subcommands
6. Script: `./quality.sh test --package dev.alexandria` targets correctly
</verification>

<success_criteria>
- quality.sh is executable with subcommands: test, mutation, spotbugs, arch, coverage, all, help
- quality.sh supports --package targeting for test and mutation subcommands
- quality.sh prints concise text summaries (under 5 lines per gate)
- GitHub Actions CI has 5 parallel jobs: test, coverage, spotbugs, mutation, sonarcloud
- Only test job failure blocks merge
- All non-test jobs use continue-on-error: true
- Report artifacts (HTML) are uploaded as GitHub Actions artifacts
- SonarCloud job uses fetch-depth: 0 and passes SONAR_TOKEN + GITHUB_TOKEN
- gradle/actions/setup-gradle@v5 used in all jobs (not deprecated gradle-build-action)
</success_criteria>

<output>
After completion, create `.planning/phases/00-ci-quality-gate/00-02-SUMMARY.md`
</output>

---
phase: 00-ci-quality-gate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - build.gradle.kts
  - settings.gradle.kts
  - gradle.properties
  - gradle/wrapper/gradle-wrapper.properties
  - gradle/wrapper/gradle-wrapper.jar
  - gradlew
  - gradlew.bat
  - src/main/java/dev/alexandria/AlexandriaApplication.java
  - src/main/resources/application.properties
  - src/test/java/dev/alexandria/AlexandriaApplicationTest.java
  - src/test/java/dev/alexandria/architecture/ArchitectureTest.java
  - src/integrationTest/java/dev/alexandria/SmokeIntegrationTest.java
  - config/spotbugs/exclude-filter.xml
autonomous: true

must_haves:
  truths:
    - "./gradlew test runs unit tests and passes on the skeleton project"
    - "./gradlew integrationTest runs integration tests (separate source set) and passes"
    - "./gradlew pitest generates a mutation testing report without blocking the build"
    - "./gradlew spotbugsMain generates a bug analysis report without blocking the build"
    - "./gradlew test jacocoTestReport generates XML and HTML coverage reports"
    - "ArchUnit tests analyze dev.alexandria package and pass with initial architecture rules"
  artifacts:
    - path: "build.gradle.kts"
      provides: "Gradle build with all quality gate plugins configured"
      contains: "info.solidsoft.pitest"
    - path: "settings.gradle.kts"
      provides: "Project settings with plugin management"
      contains: "alexandria"
    - path: "src/main/java/dev/alexandria/AlexandriaApplication.java"
      provides: "Minimal Spring Boot application class"
      contains: "@SpringBootApplication"
    - path: "src/test/java/dev/alexandria/AlexandriaApplicationTest.java"
      provides: "Minimal unit test for smoke testing"
      contains: "@Test"
    - path: "src/test/java/dev/alexandria/architecture/ArchitectureTest.java"
      provides: "ArchUnit rules for package dependency constraints"
      contains: "@AnalyzeClasses"
    - path: "src/integrationTest/java/dev/alexandria/SmokeIntegrationTest.java"
      provides: "Placeholder integration test using JVM Test Suite source set"
      contains: "@Test"
    - path: "config/spotbugs/exclude-filter.xml"
      provides: "SpotBugs exclusion filter configuration"
      contains: "FindBugsFilter"
  key_links:
    - from: "build.gradle.kts"
      to: "src/test/"
      via: "JVM Test Suite plugin configures test and integrationTest suites"
      pattern: "testing.*suites.*integrationTest"
    - from: "build.gradle.kts"
      to: "config/spotbugs/exclude-filter.xml"
      via: "SpotBugs plugin references exclude filter"
      pattern: "excludeFilter"
    - from: "build.gradle.kts"
      to: "build/reports/jacoco/"
      via: "JaCoCo task generates XML report consumed by SonarCloud"
      pattern: "jacocoTestReport"
---

<objective>
Create the complete Gradle project skeleton for Alexandria with all quality gate plugins configured and verified. This establishes the build infrastructure that every subsequent phase depends on.

Purpose: All quality gate tools (JaCoCo, PIT, SpotBugs, ArchUnit) require bytecode to analyze. Without a compilable skeleton with at least one class and test, no quality gate can run. This plan creates that foundation and configures every plugin per user decisions.
Output: A working Gradle project where `./gradlew test`, `./gradlew integrationTest`, `./gradlew pitest`, `./gradlew spotbugsMain`, and `./gradlew jacocoTestReport` all execute successfully.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-ci-quality-gate/00-CONTEXT.md
@.planning/phases/00-ci-quality-gate/00-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Spring Boot Gradle project with skeleton sources</name>
  <files>
    build.gradle.kts
    settings.gradle.kts
    gradle.properties
    gradle/wrapper/gradle-wrapper.properties
    src/main/java/dev/alexandria/AlexandriaApplication.java
    src/main/resources/application.properties
    src/test/java/dev/alexandria/AlexandriaApplicationTest.java
    src/integrationTest/java/dev/alexandria/SmokeIntegrationTest.java
  </files>
  <action>
    Generate the Gradle wrapper using `gradle wrapper --gradle-version 8.12` (install Gradle first if needed via SDKMAN or direct download). If Gradle is not available on the system, download the wrapper JAR and properties manually per Gradle docs.

    Create `settings.gradle.kts`:
    - rootProject.name = "alexandria"
    - pluginManagement block with gradlePluginPortal() and mavenCentral() repositories

    Create `gradle.properties`:
    - org.gradle.parallel=true
    - org.gradle.caching=true

    Create `build.gradle.kts` with:
    - plugins block: java, org.springframework.boot 3.5.2, io.spring.dependency-management 1.1.7, jacoco, info.solidsoft.pitest 1.15.0, com.github.spotbugs 6.4.8, org.sonarqube 7.2.2.6593
    - java toolchain: Java 21 (languageVersion = JavaLanguageVersion.of(21))
    - repositories: mavenCentral()
    - dependencies: spring-boot-starter, spring-boot-starter-test (testImplementation), archunit-junit5:1.4.1 (testImplementation)
    - JVM Test Suite plugin configuration: `test` suite using JUnit Jupiter, `integrationTest` suite registered with its own dependencies (project(), spring-boot-starter-test, spring-boot-testcontainers, testcontainers:postgresql, testcontainers:junit-jupiter). Wire integrationTest into check task: `tasks.named("check") { dependsOn(testing.suites.named("integrationTest")) }`
    - integrationTest shouldRunAfter(test)

    Create `src/main/java/dev/alexandria/AlexandriaApplication.java`:
    - @SpringBootApplication class with main method
    - Exactly as documented in RESEARCH.md code examples

    Create `src/main/resources/application.properties`:
    - spring.application.name=alexandria
    - Empty otherwise (placeholder for future config)

    Create `src/test/java/dev/alexandria/AlexandriaApplicationTest.java`:
    - Simple unit test using JUnit 5 and AssertJ
    - Verify AlexandriaApplication class is not null (no Spring context load -- that is for integration tests)

    Create `src/integrationTest/java/dev/alexandria/SmokeIntegrationTest.java`:
    - @SpringBootTest annotation
    - Simple test that verifies Spring context loads
    - No Testcontainers yet (no DB dependency in Phase 0 skeleton). Testcontainers dependencies are declared for future phases.

    Run `./gradlew test` to verify compilation and unit tests pass.
    Run `./gradlew integrationTest` to verify the integration test suite is configured and the smoke test passes.
  </action>
  <verify>
    ./gradlew test --console=plain passes with 1+ tests executed.
    ./gradlew integrationTest --console=plain passes with 1+ tests executed.
    ./gradlew classes compiles without errors.
  </verify>
  <done>
    Spring Boot 3.5.2 skeleton compiles, unit test passes in `test` suite, integration test passes in `integrationTest` suite, both suites use JUnit 5, Gradle wrapper is committed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure all quality gate plugins and verify each gate runs</name>
  <files>
    build.gradle.kts
    src/test/java/dev/alexandria/architecture/ArchitectureTest.java
    config/spotbugs/exclude-filter.xml
  </files>
  <action>
    Add quality gate configuration to `build.gradle.kts` (appending to the file created in Task 1):

    **JaCoCo configuration:**
    - toolVersion = "0.8.14"
    - jacocoTestReport task: dependsOn(test), xml.required = true, html.required = true, csv.required = false
    - NO jacocoTestCoverageVerification (non-blocking per user decision)

    **PIT (pitest) configuration:**
    - pitestVersion = "1.19.1"
    - junit5PluginVersion = "1.2.3"
    - targetClasses = listOf("dev.alexandria.*")
    - threads = Runtime.getRuntime().availableProcessors()
    - outputFormats = listOf("HTML", "XML")
    - timestampedReports = false
    - No failWhenNoMutations, no mutationThreshold (non-blocking per user decision)
    - timeoutConstInMillis = 10000 (generous timeout per research pitfall #1)

    **SpotBugs configuration:**
    - ignoreFailures = true (warn mode per user decision)
    - effort = Effort.DEFAULT
    - reportLevel = Confidence.DEFAULT
    - Configure SpotBugsTask reports: create HTML and XML reports
    - Reference exclude filter: excludeFilter = file("config/spotbugs/exclude-filter.xml")

    **SonarCloud configuration:**
    - sonar properties: sonar.projectKey (placeholder -- will need actual values), sonar.organization (placeholder), sonar.host.url = "https://sonarcloud.io"
    - sonar.coverage.jacoco.xmlReportPaths pointing to build/reports/jacoco/test/jacocoTestReport.xml

    Create `config/spotbugs/exclude-filter.xml`:
    - Standard SpotBugs exclude filter with FindBugsFilter root element
    - Exclude Spring Boot auto-generated classes (match class pattern "dev.alexandria.AlexandriaApplication" for the main method)
    - Leave room for future exclusions with comments

    Create `src/test/java/dev/alexandria/architecture/ArchitectureTest.java`:
    - @AnalyzeClasses(packages = "dev.alexandria", importOptions = ImportOption.DoNotIncludeTests.class)
    - Use the corrected cycle-free check from RESEARCH.md: `slices().matching("dev.alexandria.(*)..").should().beFreeOfCycles()`
    - Rule: feature packages (..ingestion.., ..search.., ..source.., ..document..) should not depend on adapter packages (..mcp.., ..api..)
    - Rule: config package should not depend on feature packages
    - NOTE: On a skeleton project with only one class, most rules will pass vacuously. This is expected. The rules enforce structure as the codebase grows.

    Run each quality gate individually and verify:
    1. `./gradlew test jacocoTestReport` -- produces XML at build/reports/jacoco/test/jacocoTestReport.xml
    2. `./gradlew pitest` -- produces HTML report at build/reports/pitest/
    3. `./gradlew spotbugsMain` -- runs without blocking (ignoreFailures = true)
    4. `./gradlew test --tests "dev.alexandria.architecture.*"` -- ArchUnit tests pass
  </action>
  <verify>
    ./gradlew test jacocoTestReport --console=plain succeeds AND build/reports/jacoco/test/jacocoTestReport.xml exists.
    ./gradlew pitest --console=plain succeeds AND build/reports/pitest/ directory contains index.html.
    ./gradlew spotbugsMain --console=plain succeeds (ignoreFailures = true) AND build/reports/spotbugs/ directory has a report file.
    ./gradlew test --tests "dev.alexandria.architecture.*" --console=plain passes.
  </verify>
  <done>
    All six quality gate tools are configured in build.gradle.kts and produce reports: JaCoCo (XML+HTML), PIT (HTML+XML), SpotBugs (HTML+XML), ArchUnit (via JUnit). No tool blocks the build except test failures. The non-blocking philosophy is fully implemented.
  </done>
</task>

</tasks>

<verification>
Run the full quality pipeline locally:

1. `./gradlew clean test integrationTest jacocoTestReport spotbugsMain pitest --console=plain` -- all tasks complete without build failure
2. Verify report artifacts exist:
   - build/reports/tests/test/index.html (unit test report)
   - build/reports/tests/integrationTest/index.html (integration test report)
   - build/reports/jacoco/test/jacocoTestReport.xml (coverage XML for SonarCloud)
   - build/reports/pitest/index.html (mutation report)
   - build/reports/spotbugs/ (SpotBugs report)
3. ArchUnit tests execute as part of `./gradlew test`
</verification>

<success_criteria>
- Spring Boot 3.5.2 project compiles with Java 21 toolchain
- Unit tests (test suite) and integration tests (integrationTest suite) run as separate Gradle tasks
- JaCoCo produces XML + HTML coverage reports without enforcing thresholds
- PIT runs mutation testing against dev.alexandria.* and produces HTML + XML reports
- SpotBugs analyzes main bytecode in warn mode (ignoreFailures = true)
- ArchUnit tests enforce package dependency rules
- SonarCloud plugin configured (ready for CI integration with actual tokens)
- No quality gate blocks the build except test failures
</success_criteria>

<output>
After completion, create `.planning/phases/00-ci-quality-gate/00-01-SUMMARY.md`
</output>

---
phase: 05-mcp-server
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/dev/alexandria/mcp/TokenBudgetTruncator.java
  - src/main/java/dev/alexandria/mcp/McpToolService.java
  - src/main/java/dev/alexandria/mcp/McpToolConfig.java
  - src/main/resources/application.yml
autonomous: true
requirements:
  - MCP-01
  - MCP-02
  - MCP-03
  - MCP-04
  - MCP-05

must_haves:
  truths:
    - "6 MCP tools are registered and callable via MethodToolCallbackProvider"
    - "search_docs returns formatted search results truncated to token budget"
    - "list_sources returns formatted source list from SourceRepository"
    - "add_source, remove_source, crawl_status, recrawl_source return stub responses"
    - "All tool methods catch exceptions and return structured error strings"
    - "Tool descriptions are verb-first, front-loaded, 1-2 sentences"
  artifacts:
    - path: "src/main/java/dev/alexandria/mcp/TokenBudgetTruncator.java"
      provides: "Token budget enforcement for search results"
      contains: "estimateTokens"
    - path: "src/main/java/dev/alexandria/mcp/McpToolService.java"
      provides: "6 @Tool-annotated methods for MCP exposure"
      contains: "@Tool"
    - path: "src/main/java/dev/alexandria/mcp/McpToolConfig.java"
      provides: "ToolCallbackProvider bean registration"
      contains: "MethodToolCallbackProvider"
  key_links:
    - from: "src/main/java/dev/alexandria/mcp/McpToolConfig.java"
      to: "McpToolService"
      via: "MethodToolCallbackProvider.builder().toolObjects()"
      pattern: "toolObjects.*toolService"
    - from: "src/main/java/dev/alexandria/mcp/McpToolService.java"
      to: "SearchService"
      via: "constructor injection + searchDocs delegation"
      pattern: "searchService\\.search"
    - from: "src/main/java/dev/alexandria/mcp/McpToolService.java"
      to: "TokenBudgetTruncator"
      via: "constructor injection + truncateToTokenBudget call"
      pattern: "truncator\\.truncate"
---

<objective>
Create the MCP adapter package with 6 tool methods, token budget truncation, and Spring AI bean registration.

Purpose: This is the core MCP integration layer that makes Alexandria's search and management capabilities accessible to Claude Code. All 6 tools are wired as @Tool-annotated methods registered via MethodToolCallbackProvider. The search_docs tool delegates to SearchService with token budget enforcement. Source management tools (add_source, remove_source, crawl_status, recrawl_source) are implemented as stubs returning informative messages (Phase 6 will provide full orchestration).

Output: Three production classes in `dev.alexandria.mcp` package + token budget config property.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-mcp-server/05-RESEARCH.md

Key existing code to reference:
@src/main/java/dev/alexandria/search/SearchService.java
@src/main/java/dev/alexandria/search/SearchResult.java
@src/main/java/dev/alexandria/search/SearchRequest.java
@src/main/java/dev/alexandria/source/Source.java
@src/main/java/dev/alexandria/source/SourceRepository.java
@src/main/java/dev/alexandria/source/SourceStatus.java
@src/main/resources/application.yml
@src/main/resources/application-stdio.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TokenBudgetTruncator and McpToolService</name>
  <files>
    src/main/java/dev/alexandria/mcp/TokenBudgetTruncator.java
    src/main/java/dev/alexandria/mcp/McpToolService.java
    src/main/resources/application.yml
  </files>
  <action>
Create `TokenBudgetTruncator` as a Spring `@Component` in `dev.alexandria.mcp`:

- Constructor takes `@Value("${alexandria.mcp.token-budget:5000}") int tokenBudget`
- Method `String truncate(List<SearchResult> results)`:
  - Iterates over results, formatting each as a text block with source URL, section path, and content text
  - Format per result: `## [N] Source: {sourceUrl}\nSection: {sectionPath}\n\n{text}\n\n---`
  - Estimates tokens as `(int) Math.ceil(text.length() / 4.0)` (chars/4 industry standard)
  - Stops adding results when next result would exceed the token budget
  - Returns the concatenated formatted string
  - If zero results fit within budget, include at least the first result (truncated at char level if needed)
- Make `tokenBudget` accessible via getter for testability

Add to `application.yml` under `alexandria:` block:
```yaml
alexandria:
  mcp:
    token-budget: 5000
```

Create `McpToolService` as a Spring `@Service` in `dev.alexandria.mcp`:

- Constructor injection: `SearchService`, `SourceRepository`, `TokenBudgetTruncator`
- 6 `@Tool`-annotated methods with snake_case names and front-loaded descriptions:

1. `search_docs`:
   - Params: `@ToolParam String query`, `@ToolParam Integer maxResults`
   - Validate query not null/blank, clamp maxResults to 1-50 range (default 10)
   - Delegate to `searchService.search(new SearchRequest(query, max))`
   - Pass results to `truncator.truncate(results)`
   - On empty results: return `"No results found for query: {query}"`
   - Catch all exceptions, return `"Error searching documentation: {message}"`

2. `list_sources`:
   - No params
   - Delegate to `sourceRepository.findAll()`
   - Format each source as: `"- {name} ({url}): {status} | {chunkCount} chunks | last crawled: {lastCrawledAt or 'never'}"`
   - On empty: return `"No documentation sources configured. Use add_source to add one."`
   - Catch all exceptions, return `"Error listing sources: {message}"`

3. `add_source` (stub for Phase 6):
   - Params: `@ToolParam String url`, `@ToolParam String name`
   - Validate url not null/blank
   - Create `new Source(url, name)`, save via `sourceRepository.save()`
   - Return `"Source '{name}' added in PENDING status. Crawling will be available in a future update."`
   - Catch all exceptions, return `"Error adding source: {message}"`

4. `remove_source` (stub for Phase 6):
   - Params: `@ToolParam String sourceId`
   - Parse UUID, call `sourceRepository.deleteById(uuid)`
   - Return `"Source {sourceId} removed."`
   - Catch `IllegalArgumentException` for invalid UUID format
   - Catch all exceptions, return `"Error removing source: {message}"`

5. `crawl_status` (stub):
   - Params: `@ToolParam String sourceId`
   - Parse UUID, look up source via `sourceRepository.findById(uuid)`
   - If found, return source status info. If not found, return error.
   - Return `"Source: {name} | Status: {status} | Chunks: {chunkCount} | Last crawled: {lastCrawledAt or 'never'}. Detailed crawl progress will be available in a future update."`
   - Catch all exceptions, return `"Error checking crawl status: {message}"`

6. `recrawl_source` (stub):
   - Params: `@ToolParam String sourceId`
   - Parse UUID, verify source exists via `sourceRepository.findById(uuid)`
   - Return `"Recrawl requested for source '{name}'. Recrawl functionality will be available in a future update."`
   - Catch all exceptions, return `"Error requesting recrawl: {message}"`

Tool description guidelines (MCP-02):
- search_docs: "Search indexed documentation by semantic query. Returns relevant excerpts with source URLs and section paths for citation."
- list_sources: "List all indexed documentation sources with status, last crawl time, and chunk count."
- add_source: "Add a new documentation source URL for indexing. The source is created in PENDING status."
- remove_source: "Remove a documentation source and its indexed data by source ID."
- crawl_status: "Check the crawl status and index statistics for a documentation source by ID."
- recrawl_source: "Request a re-crawl of an existing documentation source to refresh its indexed content."

All methods follow the structured error pattern (MCP-03): catch all exceptions inside the method body, return descriptive error strings starting with "Error:", never throw.

Add Javadoc to both classes per project convention.
  </action>
  <verify>
    `./quality.sh test` passes (compilation check). `grep -r "@Tool" src/main/java/dev/alexandria/mcp/` shows 6 annotated methods. `grep -r "Error" src/main/java/dev/alexandria/mcp/McpToolService.java` confirms structured error handling in every method.
  </verify>
  <done>
    TokenBudgetTruncator formats and truncates SearchResult lists to a configurable token budget. McpToolService exposes 6 @Tool methods with structured error handling and front-loaded descriptions. Token budget property configured with 5000 default.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create McpToolConfig and verify wiring</name>
  <files>
    src/main/java/dev/alexandria/mcp/McpToolConfig.java
  </files>
  <action>
Create `McpToolConfig` as a Spring `@Configuration` class in `dev.alexandria.mcp`:

```java
@Configuration
public class McpToolConfig {

    @Bean
    public ToolCallbackProvider alexandriaTools(McpToolService toolService) {
        return MethodToolCallbackProvider.builder()
                .toolObjects(toolService)
                .build();
    }
}
```

Imports:
- `org.springframework.ai.tool.ToolCallbackProvider`
- `org.springframework.ai.tool.method.MethodToolCallbackProvider`

Add Javadoc explaining this registers McpToolService methods as MCP tools via Spring AI auto-configuration.

Verify that ArchUnit rules still pass (mcp is an adapter package, it depends on feature packages search/source which is correct direction).
  </action>
  <verify>
    `./quality.sh test` passes (compilation + ArchUnit). No ArchUnit violations for the mcp -> search/source dependency direction.
  </verify>
  <done>
    McpToolConfig registers McpToolService via MethodToolCallbackProvider. Spring AI auto-configuration wires tools into MCP stdio/SSE transport. ArchUnit confirms adapter -> feature dependency direction is valid.
  </done>
</task>

</tasks>

<verification>
1. `./quality.sh test` passes -- compilation, unit tests, ArchUnit all green
2. `grep -c "@Tool" src/main/java/dev/alexandria/mcp/McpToolService.java` returns 6
3. `grep "MethodToolCallbackProvider" src/main/java/dev/alexandria/mcp/McpToolConfig.java` confirms bean registration
4. `grep "token-budget" src/main/resources/application.yml` confirms configurable property
5. All 6 tool methods have try-catch with "Error:" return pattern
6. No System.out.println in any mcp/ file (would corrupt stdio transport)
</verification>

<success_criteria>
- 3 new Java files in `dev.alexandria.mcp` package: TokenBudgetTruncator, McpToolService, McpToolConfig
- 6 @Tool-annotated methods with snake_case names matching MCP-05 spec
- All tool methods catch exceptions and return structured error strings (MCP-03)
- Tool descriptions are verb-first, front-loaded, 1-2 sentences (MCP-02)
- Token budget configurable via `alexandria.mcp.token-budget` property, default 5000 (MCP-04)
- ToolCallbackProvider bean registered for Spring AI auto-configuration (MCP-01)
- `./quality.sh test` passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-mcp-server/05-01-SUMMARY.md`
</output>

---
phase: 11-quality-security-tooling
plan: 03
type: execute
wave: 3
depends_on:
  - 11-02
files_modified:
  - build.gradle.kts
  - gradle/libs.versions.toml
  - .github/workflows/ci.yml
  - owasp-suppressions.xml
  - .trivyignore
  - quality.sh
autonomous: true
requirements:
  - SECU-01
  - SECU-02
  - SECU-03

must_haves:
  truths:
    - "OWASP Dependency-Check runs as part of ./gradlew build and fails on CVSS >= 7.0"
    - "CycloneDX generates an SBOM artifact (JSON or XML) during the build"
    - "Trivy scans all 3 Docker images (postgres, crawl4ai, app) in CI and fails on HIGH/CRITICAL CVEs"
    - "Trivy scans the Java filesystem (project dependencies) in CI"
    - "owasp-suppressions.xml exists for suppressing known false-positive CVEs with justification"
    - ".trivyignore exists for suppressing accepted Trivy CVE findings with justification"
  artifacts:
    - path: "build.gradle.kts"
      provides: "OWASP Dependency-Check and CycloneDX plugin configuration"
      contains: "dependencyCheck"
    - path: "gradle/libs.versions.toml"
      provides: "OWASP and CycloneDX plugin versions"
      contains: "owasp"
    - path: ".github/workflows/ci.yml"
      provides: "Trivy scanning CI job for Docker images and filesystem"
      contains: "trivy"
    - path: "owasp-suppressions.xml"
      provides: "OWASP Dependency-Check false positive suppressions"
      contains: "suppressions"
    - path: ".trivyignore"
      provides: "Trivy CVE suppression list"
    - path: "quality.sh"
      provides: "Updated quality gate script with OWASP and SBOM commands"
      contains: "owasp"
  key_links:
    - from: "build.gradle.kts"
      to: "owasp-suppressions.xml"
      via: "suppressionFile configuration"
      pattern: "suppressionFile"
    - from: ".github/workflows/ci.yml"
      to: ".trivyignore"
      via: "Trivy --ignorefile flag"
      pattern: "trivyignore"
    - from: "build.gradle.kts"
      to: "CycloneDX SBOM"
      via: "cyclonedxBom task produces build/reports/bom.*"
      pattern: "cyclonedxBom"
---

<objective>
Integrate OWASP Dependency-Check and CycloneDX SBOM generation into the Gradle build, and add Trivy container/filesystem scanning to the CI pipeline.

Purpose: SECU-01 requires Trivy scanning of Docker images + Java filesystem in CI. SECU-02 requires OWASP Dependency-Check in the Gradle build with CVSS 7.0 threshold. SECU-03 requires CycloneDX SBOM generation. Per locked decisions: OWASP runs in `./gradlew build` (local + CI), Trivy runs in CI only, suppression files are committed and reviewed.

Output: Vulnerable dependencies detected at build time (OWASP) and in CI (Trivy). SBOM generated every build. Suppression files for false positives.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-quality-security-tooling/11-02-SUMMARY.md
@build.gradle.kts
@gradle/libs.versions.toml
@.github/workflows/ci.yml
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OWASP Dependency-Check and CycloneDX to Gradle build</name>
  <files>
    build.gradle.kts
    gradle/libs.versions.toml
    owasp-suppressions.xml
    quality.sh
  </files>
  <action>
    Add dependency vulnerability scanning and SBOM generation to the Gradle build:

    1. **gradle/libs.versions.toml** — Add plugin versions:
       - `owasp-depcheck = "12.1.1"` (org.owasp.dependencycheck)
       - `cyclonedx = "2.2.1"` (org.cyclonedx.bom)
       Add plugin entries:
       - `owasp-depcheck = { id = "org.owasp.dependencycheck", version.ref = "owasp-depcheck" }`
       - `cyclonedx = { id = "org.cyclonedx.bom", version.ref = "cyclonedx" }`

    2. **build.gradle.kts** — Add plugins:
       ```kotlin
       alias(libs.plugins.owasp.depcheck)
       alias(libs.plugins.cyclonedx)
       ```

       Configure OWASP Dependency-Check:
       ```kotlin
       dependencyCheck {
           failBuildOnCVSS = 7.0f
           suppressionFile = "owasp-suppressions.xml"
           analyzers {
               assemblyEnabled = false   // .NET analyzer, not needed
               nodeEnabled = false        // Node.js analyzer, not needed
           }
           formats = listOf("HTML", "JSON")
       }
       ```

       Wire OWASP check into the build lifecycle so `./gradlew build` runs it:
       ```kotlin
       tasks.named("check") {
           dependsOn("dependencyCheckAnalyze")
       }
       ```

       Configure CycloneDX SBOM:
       ```kotlin
       tasks.named("cyclonedxBom") {
           // CycloneDX plugin auto-configures; SBOM output at build/reports/bom.json
       }
       ```
       Wire CycloneDX into the build:
       ```kotlin
       tasks.named("build") {
           dependsOn("cyclonedxBom")
       }
       ```

    3. **owasp-suppressions.xml** — Create the suppression file at repo root:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <suppressions xmlns="https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.3.xsd">
           <!-- Suppression entries go here with justification comments -->
           <!-- Example:
           <suppress>
               <notes>CVE-XXXX-XXXXX: False positive - not exploitable in our usage because ...</notes>
               <cve>CVE-XXXX-XXXXX</cve>
           </suppress>
           -->
       </suppressions>
       ```
       Per locked decision: dedicated file with justification for each suppressed CVE.

    4. **quality.sh** — Add new subcommands:
       - `owasp` — Runs `./gradlew dependencyCheckAnalyze` and summarizes results (count of vulnerabilities by severity)
       - `sbom` — Runs `./gradlew cyclonedxBom` and prints SBOM location
       Update the `all` command to include OWASP in its pipeline.
       Update the `help` command to document the new subcommands.

    5. **Run and fix** — Execute `./gradlew dependencyCheckAnalyze` to get a baseline. If any dependencies have CVSS >= 7.0 that are false positives or cannot be immediately resolved, add suppressions to `owasp-suppressions.xml` with justification. The goal is `./gradlew build` passing with OWASP active.
  </action>
  <verify>
    Run `./gradlew dependencyCheckAnalyze --console=plain` — must complete (may find vulnerabilities).
    Run `./gradlew cyclonedxBom --console=plain` — must produce build/reports/bom.json.
    Run `./gradlew build -x integrationTest --console=plain` — must PASS with OWASP + CycloneDX active.
    Verify `owasp-suppressions.xml` exists at repo root.
    Run `./quality.sh owasp` — must run and print summary.
  </verify>
  <done>
    OWASP Dependency-Check runs as part of `./gradlew build` with CVSS 7.0 fail threshold. CycloneDX generates SBOM on every build. Suppression file exists. quality.sh updated with owasp and sbom commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Trivy scanning to CI pipeline</name>
  <files>
    .github/workflows/ci.yml
    .trivyignore
  </files>
  <action>
    Add Trivy security scanning to the GitHub Actions CI pipeline:

    1. **.trivyignore** — Create at repo root:
       ```
       # Trivy CVE suppressions for Alexandria
       # Each entry: CVE-ID followed by justification comment
       # Example:
       # CVE-XXXX-XXXXX  # Not exploitable: library used only for X
       ```
       Per locked decision: `.trivyignore` file committed to repo with justification comments.

    2. **.github/workflows/ci.yml** — Add a new `security` job after the `build` job:

       ```yaml
       security:
         name: Security Scanning (Trivy)
         needs: [build]
         runs-on: ubuntu-latest
         steps:
           - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

           - name: Run Trivy filesystem scan (Java dependencies)
             uses: aquasecurity/trivy-action@18f2510ee396bbf400402947e7f25f6758cce1c6 # v0.30.0
             with:
               scan-type: fs
               scan-ref: .
               severity: HIGH,CRITICAL
               exit-code: 1
               trivyignores: .trivyignore
               format: table

           - name: Scan PostgreSQL image
             uses: aquasecurity/trivy-action@18f2510ee396bbf400402947e7f25f6758cce1c6 # v0.30.0
             with:
               image-ref: pgvector/pgvector:pg16
               severity: HIGH,CRITICAL
               exit-code: 1
               trivyignores: .trivyignore
               format: table

           - name: Scan Crawl4AI image
             uses: aquasecurity/trivy-action@18f2510ee396bbf400402947e7f25f6758cce1c6 # v0.30.0
             with:
               image-ref: unclecode/crawl4ai:0.8.0
               severity: HIGH,CRITICAL
               exit-code: 1
               trivyignores: .trivyignore
               format: table

           - name: Build app image for scanning
             run: docker build -t alexandria:scan .

           - name: Scan Alexandria app image
             uses: aquasecurity/trivy-action@18f2510ee396bbf400402947e7f25f6758cce1c6 # v0.30.0
             with:
               image-ref: alexandria:scan
               severity: HIGH,CRITICAL
               exit-code: 1
               trivyignores: .trivyignore
               format: table
       ```

       Notes:
       - Pin trivy-action to a specific commit SHA (look up the latest v0.30.x or similar stable release SHA)
       - The filesystem scan catches Java dependency vulnerabilities
       - Three image scans: pgvector/pgvector:pg16, unclecode/crawl4ai:0.8.0, and the built app image
       - `exit-code: 1` means the job fails on HIGH/CRITICAL findings
       - Per locked decision: Trivy runs in CI only, NOT in the local Gradle build

       Position the security job to run in parallel with test/spotbugs/mutation (needs: [build]).
  </action>
  <verify>
    Verify `.trivyignore` exists at repo root.
    Verify `.github/workflows/ci.yml` contains the security job with 4 Trivy scan steps (filesystem + 3 images).
    Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` or similar.
    The CI job will be validated when pushed — local verification confirms file structure.
  </verify>
  <done>
    Trivy CI job scans Java filesystem and all 3 Docker images (pgvector, crawl4ai, app) for HIGH/CRITICAL CVEs. .trivyignore file exists for suppressions. CI pipeline fails on security findings.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build -x integrationTest` passes with OWASP active and CVSS >= 7.0 threshold (SECU-02)
2. `build/reports/bom.json` exists after build (SECU-03: CycloneDX SBOM)
3. CI YAML contains Trivy job scanning filesystem + 3 images (SECU-01)
4. `owasp-suppressions.xml` exists with proper schema (SECU-02)
5. `.trivyignore` exists (SECU-01)
6. `quality.sh owasp` and `quality.sh sbom` work correctly
</verification>

<success_criteria>
- OWASP Dependency-Check is part of `./gradlew build` with CVSS 7.0 fail threshold
- CycloneDX SBOM generated on every build
- Trivy scans all 3 Docker images and Java filesystem in CI
- Suppression files exist and are committed
- quality.sh extended with owasp and sbom commands
- No build regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-quality-security-tooling/11-03-SUMMARY.md`
</output>

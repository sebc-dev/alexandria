---
phase: 11-quality-security-tooling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - build.gradle.kts
  - gradle/libs.versions.toml
  - config/errorprone/bugpatterns.txt
  - .git-blame-ignore-revs
  - .git/hooks/pre-commit
  - src/main/java/**/*.java
  - src/test/java/**/*.java
  - src/integrationTest/java/**/*.java
autonomous: true
requirements:
  - QUAL-01
  - QUAL-03

must_haves:
  truths:
    - "./gradlew build fails when Error Prone detects an ERROR-level bug pattern in Java source"
    - "./gradlew spotlessCheck fails on unformatted code"
    - "spotlessApply auto-fixes formatting before each commit via pre-commit hook"
    - "git blame ignores the big-bang formatting commit via .git-blame-ignore-revs"
    - "All existing Java files pass spotlessCheck and Error Prone after the big-bang format"
  artifacts:
    - path: "build.gradle.kts"
      provides: "Error Prone and Spotless plugin configuration"
      contains: "errorprone"
    - path: "gradle/libs.versions.toml"
      provides: "Error Prone and Spotless version declarations"
      contains: "errorprone"
    - path: "config/errorprone/bugpatterns.txt"
      provides: "Centralized Error Prone suppression file"
    - path: ".git-blame-ignore-revs"
      provides: "Git blame skip list for formatting commits"
    - path: ".git/hooks/pre-commit"
      provides: "Pre-commit hook running spotlessApply"
  key_links:
    - from: "build.gradle.kts"
      to: "gradle/libs.versions.toml"
      via: "version catalog references"
      pattern: "libs\\.plugins\\."
    - from: "build.gradle.kts"
      to: "config/errorprone/bugpatterns.txt"
      via: "Error Prone flags reference"
      pattern: "errorprone"
---

<objective>
Integrate Error Prone compiler checks and Spotless code formatting into the Gradle build, then apply a big-bang format to the entire codebase.

Purpose: QUAL-01 requires Error Prone ERROR-level bug detection at compile time. QUAL-03 requires Spotless + google-java-format enforcement. Both tools must fail the build on violations (per locked decision: identical behavior local and CI).

Output: Error Prone catches bugs at compile time, Spotless enforces google-java-format, pre-commit hook auto-formats, existing code is fully formatted.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@build.gradle.kts
@gradle/libs.versions.toml
@settings.gradle.kts
@config/spotbugs/exclude-filter.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Error Prone and Spotless Gradle plugins</name>
  <files>
    build.gradle.kts
    gradle/libs.versions.toml
    config/errorprone/bugpatterns.txt
  </files>
  <action>
    Add Error Prone and Spotless to the build:

    1. **gradle/libs.versions.toml** — Add version entries:
       - `errorprone-core = "2.36.0"` (latest 2.36.x)
       - `errorprone-plugin = "4.2.0"` (net.ltgt.errorprone Gradle plugin)
       - `nullaway` version placeholder (version only, used in Plan 02)
       - `spotless = "7.0.3"` (com.diffplug.spotless)
       Add library entries for errorprone-core and nullaway JAR. Add plugin entries for errorprone and spotless.

    2. **build.gradle.kts** — Add plugins:
       ```
       alias(libs.plugins.errorprone)
       alias(libs.plugins.spotless)
       ```

       Add Error Prone dependency:
       ```
       errorprone(libs.errorprone.core)
       ```

       Configure Error Prone on all JavaCompile tasks:
       ```kotlin
       tasks.withType<JavaCompile>().configureEach {
           options.errorprone {
               isEnabled.set(true)
               disableWarningsInGeneratedCode.set(true)
               // ERROR-level checks are enabled by default
               // Centralized suppressions via exclusion file
               excludedPaths.set(".*/build/generated/.*")
           }
       }
       ```
       Error Prone ERROR severity = build fails by default. No need to set `allErrorsAsWarnings`.

       Configure Spotless:
       ```kotlin
       spotless {
           java {
               target("src/**/*.java")
               googleJavaFormat()
               ratchetFrom("origin/master")
           }
       }
       ```
       Note: ratchetFrom is for ongoing enforcement AFTER the big-bang format commit (Task 2).

    3. **config/errorprone/bugpatterns.txt** — Create centralized suppression file.
       Start with an empty file containing a comment header explaining its purpose:
       "Centralized Error Prone suppressions. Each entry disables a specific bug pattern with justification."
       Per locked decision: no inline @SuppressWarnings, all suppressions go here.
       If Error Prone flags false positives during Task 2, they get added here with justification.

    Verify the build compiles with the new plugins before proceeding to Task 2.
  </action>
  <verify>
    Run `./gradlew classes --console=plain` — must succeed with Error Prone and Spotless plugins loaded.
    Run `./gradlew spotlessCheck --console=plain` — expected to FAIL (code not yet formatted). This confirms Spotless is active.
  </verify>
  <done>
    Error Prone is active on compilation, Spotless is configured with google-java-format and ratchetFrom, centralized suppression file exists at config/errorprone/bugpatterns.txt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Big-bang format, fix Error Prone violations, and set up pre-commit hook</name>
  <files>
    src/main/java/**/*.java
    src/test/java/**/*.java
    src/integrationTest/java/**/*.java
    .git-blame-ignore-revs
    .git/hooks/pre-commit
    build.gradle.kts
    config/errorprone/bugpatterns.txt
  </files>
  <action>
    Execute the big-bang format and fix all existing violations:

    1. **Big-bang spotlessApply** — Run `./gradlew spotlessApply` to format the entire codebase with google-java-format. This is a one-time mass reformat per locked decision.

    2. **Fix Error Prone violations** — Run `./gradlew classes testClasses integrationTestClasses` to surface all ERROR-level Error Prone findings. Fix each violation in the source code. If any are false positives from third-party patterns that cannot be fixed, add the bug pattern name to `config/errorprone/bugpatterns.txt` with a justification comment, and configure the exclusion in build.gradle.kts using `error(bugPattern)` → `disable(bugPattern)` syntax via `options.errorprone { disable("PatternName") }` or an `errorprone.excludedPaths` for generated code.

    3. **Commit formatting separately** — The big-bang format changes go in a dedicated commit so git blame can skip it. Note the commit SHA.

    4. **.git-blame-ignore-revs** — Create this file at repo root with the SHA of the formatting commit. Format:
       ```
       # Spotless big-bang google-java-format (Phase 11)
       <SHA>
       ```

    5. **Pre-commit hook** — Create `.git/hooks/pre-commit` (executable):
       ```bash
       #!/usr/bin/env bash
       # Auto-format staged Java files before commit (Phase 11)
       ./gradlew spotlessApply --console=plain -q 2>/dev/null
       git add -u -- '*.java'
       ```
       Make executable: `chmod +x .git/hooks/pre-commit`.
       Per locked decision: spotlessApply auto-fixes formatting before each commit.
       Note: The hook file is in .git/hooks/ (not committed to repo). To share it, also create a `scripts/pre-commit` file that gets installed via a Gradle task or manual copy. Create `scripts/install-hooks.sh` that copies it to `.git/hooks/`.

    6. **Verify clean build** — Run `./gradlew build -x integrationTest` to confirm everything passes with Error Prone + Spotless active.
  </action>
  <verify>
    Run `./gradlew spotlessCheck --console=plain` — must PASS (all code formatted).
    Run `./gradlew classes testClasses --console=plain` — must PASS with zero Error Prone errors.
    Run `./gradlew test --console=plain` — all existing unit tests still pass.
    Verify `.git-blame-ignore-revs` exists and contains a valid SHA.
    Verify `.git/hooks/pre-commit` exists and is executable.
  </verify>
  <done>
    All Java files formatted with google-java-format. Zero Error Prone ERROR-level violations. Pre-commit hook installed. .git-blame-ignore-revs configured. `./gradlew build -x integrationTest` passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew spotlessCheck` passes (QUAL-03: formatting enforced)
2. `./gradlew classes testClasses integrationTestClasses` passes with Error Prone active (QUAL-01: bug detection)
3. `./gradlew test` passes (no regressions from formatting or Error Prone fixes)
4. `.git-blame-ignore-revs` exists with formatting commit SHA
5. Pre-commit hook auto-formats on commit
</verification>

<success_criteria>
- Error Prone ERROR-level checks are active and fail the build on detection
- Spotless enforces google-java-format with ratchetFrom for ongoing changes
- Entire codebase is formatted (big-bang apply completed)
- Pre-commit hook runs spotlessApply automatically
- No existing test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-quality-security-tooling/11-01-SUMMARY.md`
</output>

---
phase: 11-quality-security-tooling
plan: 02
type: execute
wave: 2
depends_on:
  - 11-01
files_modified:
  - build.gradle.kts
  - gradle/libs.versions.toml
  - src/main/java/dev/alexandria/package-info.java
  - src/main/java/dev/alexandria/config/package-info.java
  - src/main/java/dev/alexandria/crawl/package-info.java
  - src/main/java/dev/alexandria/document/package-info.java
  - src/main/java/dev/alexandria/ingestion/package-info.java
  - src/main/java/dev/alexandria/ingestion/chunking/package-info.java
  - src/main/java/dev/alexandria/ingestion/prechunked/package-info.java
  - src/main/java/dev/alexandria/mcp/package-info.java
  - src/main/java/dev/alexandria/search/package-info.java
  - src/main/java/dev/alexandria/source/package-info.java
  - src/main/java/**/*.java
autonomous: true
requirements:
  - QUAL-02

must_haves:
  truths:
    - "NullAway reports null safety violations at compile time for all packages under dev.alexandria"
    - "All packages have @NullMarked package-info.java files marking them as null-safe by default"
    - "Nullable parameters and return types are explicitly annotated with @Nullable throughout the codebase"
    - "./gradlew build fails if a method passes null to a @NonNull parameter without a @Nullable annotation"
  artifacts:
    - path: "build.gradle.kts"
      provides: "NullAway Error Prone check configuration"
      contains: "NullAway"
    - path: "gradle/libs.versions.toml"
      provides: "NullAway and JSpecify dependency versions"
      contains: "nullaway"
    - path: "src/main/java/dev/alexandria/package-info.java"
      provides: "Root package @NullMarked annotation"
      contains: "@NullMarked"
    - path: "src/main/java/dev/alexandria/config/package-info.java"
      provides: "Config package @NullMarked annotation"
      contains: "@NullMarked"
    - path: "src/main/java/dev/alexandria/crawl/package-info.java"
      provides: "Crawl package @NullMarked annotation"
      contains: "@NullMarked"
  key_links:
    - from: "build.gradle.kts"
      to: "NullAway"
      via: "Error Prone check option"
      pattern: "option.*NullAway"
    - from: "package-info.java"
      to: "NullAway"
      via: "@NullMarked triggers NullAway analysis"
      pattern: "@NullMarked"
---

<objective>
Integrate NullAway as an Error Prone check with JSpecify annotations, and annotate the entire codebase for null safety.

Purpose: QUAL-02 requires NullAway to report null safety violations at compile time. Per locked decisions: use JSpecify (org.jspecify), cover all packages from the start, annotate all nullable parameters/returns now. Configuration and annotation go in separate commits.

Output: All dev.alexandria packages are @NullMarked, all nullable boundaries explicitly annotated with @Nullable, NullAway enforces null safety at compile time.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-quality-security-tooling/11-01-SUMMARY.md
@build.gradle.kts
@gradle/libs.versions.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure NullAway and JSpecify dependencies</name>
  <files>
    build.gradle.kts
    gradle/libs.versions.toml
  </files>
  <action>
    Add NullAway as an Error Prone check and JSpecify as the annotation library:

    1. **gradle/libs.versions.toml** — Add versions and libraries:
       - `nullaway = "0.12.6"` (latest stable)
       - `jspecify = "1.0.0"`
       Add library entries:
       - `nullaway = { module = "com.uber.nullaway:nullaway", version.ref = "nullaway" }`
       - `jspecify = { module = "org.jspecify:jspecify", version.ref = "jspecify" }`

    2. **build.gradle.kts** — Add dependencies:
       ```kotlin
       errorprone(libs.nullaway)
       implementation(libs.jspecify)
       ```

       Configure NullAway in the Error Prone block (inside tasks.withType<JavaCompile> from Plan 01):
       ```kotlin
       option("NullAway:AnnotatedPackages", "dev.alexandria")
       option("NullAway:JSpecifyMode", "true")
       ```

       NullAway in JSpecify mode treats @NullMarked packages as fully non-null by default. Any parameter, return type, or field that can be null must be annotated with @Nullable.

       For handling third-party library nullability (Spring, LangChain4j returns), use NullAway's `option("NullAway:UnannotatedSubPackages", "")` if needed, or add targeted `@SuppressWarnings("NullAway")` only on specific methods that interact with unannotated third-party code. Prefer `castToNonNull`-style assertion helpers when the value is known non-null but the library lacks annotations. Create a `dev.alexandria.config.NullSafety` utility class with a `castToNonNull(T)` method if needed.

    3. Verify compilation succeeds with NullAway loaded but no @NullMarked packages yet (NullAway only activates on annotated packages).
  </action>
  <verify>
    Run `./gradlew classes --console=plain` — must succeed (NullAway loaded but inactive since no @NullMarked packages yet).
  </verify>
  <done>
    NullAway is configured as an Error Prone check targeting dev.alexandria packages. JSpecify is on the classpath. Compilation succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add @NullMarked package annotations and @Nullable annotations to all code</name>
  <files>
    src/main/java/dev/alexandria/package-info.java
    src/main/java/dev/alexandria/config/package-info.java
    src/main/java/dev/alexandria/crawl/package-info.java
    src/main/java/dev/alexandria/document/package-info.java
    src/main/java/dev/alexandria/ingestion/package-info.java
    src/main/java/dev/alexandria/ingestion/chunking/package-info.java
    src/main/java/dev/alexandria/ingestion/prechunked/package-info.java
    src/main/java/dev/alexandria/mcp/package-info.java
    src/main/java/dev/alexandria/search/package-info.java
    src/main/java/dev/alexandria/source/package-info.java
    src/main/java/**/*.java
  </files>
  <action>
    Annotate the entire codebase for null safety:

    1. **Create package-info.java for EVERY package** (10 packages total):
       Each file contains:
       ```java
       @NullMarked
       package dev.alexandria.xxx;

       import org.jspecify.annotations.NullMarked;
       ```
       Packages to create package-info.java for:
       - dev.alexandria
       - dev.alexandria.config
       - dev.alexandria.crawl
       - dev.alexandria.document
       - dev.alexandria.ingestion
       - dev.alexandria.ingestion.chunking
       - dev.alexandria.ingestion.prechunked
       - dev.alexandria.mcp
       - dev.alexandria.search
       - dev.alexandria.source

    2. **Annotate all nullable parameters, return types, and fields** across ALL Java files:
       - Read each file, identify parameters/returns/fields that can be null
       - Add `@Nullable` (from `org.jspecify.annotations.Nullable`) to each nullable boundary
       - Common patterns to check:
         * JPA entity no-arg constructors (fields may be null before persist)
         * Optional-returning methods (return type itself is non-null, but consider the pattern)
         * Spring @Autowired fields (should not exist per convention — constructor injection only)
         * Record components that may be null
         * Method parameters documented as "may be null"
         * Repository method returns (findById returns Optional which is non-null)
         * Crawl4AI response fields that may be absent

       Focus areas (42 main Java files):
       - JPA entities: DocumentChunk, Source, IngestionState — check all fields, getters
       - Records: Crawl4AiResponse, CrawlResult, SearchResult, SearchRequest, etc. — nullable components
       - Services: check method parameters and returns
       - Config classes: check bean factory method returns

    3. **Handle third-party library interactions:**
       - Spring's @RequestParam, @PathVariable: Spring ensures non-null by default
       - LangChain4j EmbeddingModel/EmbeddingStore: returned objects may need castToNonNull
       - JPA repository methods: findById → Optional (non-null), findAll → List (non-null)
       - If needed, create `dev.alexandria.config.NullSafety` with `castToNonNull(T value)` helper

    4. **Compile and iterate** — Run `./gradlew classes testClasses integrationTestClasses` repeatedly until zero NullAway errors. Each NullAway error indicates a missing @Nullable annotation or a genuine null safety bug. Fix accordingly.

    5. **Run spotlessApply** after all annotations are added to ensure formatting compliance.
  </action>
  <verify>
    Run `./gradlew classes testClasses integrationTestClasses --console=plain` — must PASS with zero NullAway errors.
    Run `./gradlew spotlessCheck --console=plain` — must PASS.
    Run `./gradlew test --console=plain` — all unit tests still pass.
    Verify package-info.java exists in all 10 packages.
  </verify>
  <done>
    All 10 packages have @NullMarked package-info.java. All nullable boundaries annotated with @Nullable. NullAway enforces null safety at compile time with zero violations. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew classes` compiles with NullAway active and zero violations (QUAL-02)
2. All 10 packages under dev.alexandria have package-info.java with @NullMarked
3. `./gradlew test` passes with no regressions
4. NullAway is configured in JSpecify mode targeting dev.alexandria
</verification>

<success_criteria>
- NullAway reports null safety violations at compile time for all dev.alexandria packages
- JSpecify @NullMarked applied to all 10 packages
- All nullable parameters and return types annotated with @Nullable
- Build fails on null safety violations (ERROR severity by default)
- No test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-quality-security-tooling/11-02-SUMMARY.md`
</output>

---
phase: 12-performance-quick-wins
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/dev/alexandria/config/OnnxRuntimeConfig.java
  - src/main/java/dev/alexandria/search/SearchService.java
  - src/test/java/dev/alexandria/search/SearchServiceTest.java
autonomous: true
requirements:
  - PERF-01
  - CHUNK-03

must_haves:
  truths:
    - "ONNX Runtime initializes with thread spinning disabled and configured thread pools (4 intra-op, 2 inter-op)"
    - "Search queries embed with the BGE query prefix prepended, improving retrieval relevance"
    - "Documents at ingestion time are NOT prefixed (only search queries)"
  artifacts:
    - path: "src/main/java/dev/alexandria/config/OnnxRuntimeConfig.java"
      provides: "ONNX Runtime environment initialization with threading options"
      contains: "setGlobalSpinControl"
    - path: "src/main/java/dev/alexandria/search/SearchService.java"
      provides: "BGE query prefix injection before embedding"
      contains: "Represent this sentence"
    - path: "src/test/java/dev/alexandria/search/SearchServiceTest.java"
      provides: "Updated tests verifying prefixed query is embedded"
      contains: "Represent this sentence"
  key_links:
    - from: "src/main/java/dev/alexandria/config/OnnxRuntimeConfig.java"
      to: "OrtEnvironment singleton"
      via: "Early initialization via BeanFactoryPostProcessor"
      pattern: "OrtEnvironment\\.getEnvironment"
    - from: "src/main/java/dev/alexandria/search/SearchService.java"
      to: "embeddingModel.embed()"
      via: "Prefixed query string passed to embed"
      pattern: "Represent this sentence"
---

<objective>
Configure ONNX Runtime threading and add BGE query prefix to search embeddings.

Purpose: Reduce idle CPU from ONNX thread spinning, configure optimal thread pools for 4-core machine, and improve retrieval relevance by adding the BGE-recommended query prefix to search embedding requests.
Output: OnnxRuntimeConfig bean for thread pool settings, updated SearchService with query prefix.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/main/java/dev/alexandria/config/EmbeddingConfig.java
@src/main/java/dev/alexandria/search/SearchService.java
@src/test/java/dev/alexandria/search/SearchServiceTest.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure ONNX Runtime thread pools and disable spinning</name>
  <files>src/main/java/dev/alexandria/config/OnnxRuntimeConfig.java</files>
  <action>
Create a new `OnnxRuntimeConfig` configuration class in `dev.alexandria.config` that initializes the ONNX Runtime environment with custom threading options.

**Critical constraint:** The `BgeSmallEnV15QuantizedEmbeddingModel` class loads the ONNX model in a `static` field via `loadFromJar()`, which calls `OrtEnvironment.getEnvironment()`. The `OrtEnvironment` is a singleton — once created without threading options, it cannot be reconfigured. We must initialize the environment WITH threading options BEFORE Spring instantiates the `BgeSmallEnV15QuantizedEmbeddingModel` bean (which triggers the static initializer when the class is loaded).

**Approach:** Implement `BeanFactoryPostProcessor` (a Spring callback that runs before any `@Bean` methods execute). In its `postProcessBeanFactory` method, initialize the `OrtEnvironment` with threading options. This ensures the environment is configured before `EmbeddingConfig.embeddingModel()` is called, which triggers class loading of `BgeSmallEnV15QuantizedEmbeddingModel` and its static `MODEL` field.

```java
package dev.alexandria.config;

import ai.onnxruntime.OrtEnvironment;
import ai.onnxruntime.OrtException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.config.BeanFactoryPostProcessor;
import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OnnxRuntimeConfig implements BeanFactoryPostProcessor {

  private static final Logger log = LoggerFactory.getLogger(OnnxRuntimeConfig.class);

  @Override
  public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)
      throws BeansException {
    try (var threadingOptions = new OrtEnvironment.ThreadingOptions()) {
      threadingOptions.setGlobalSpinControl(false);
      threadingOptions.setGlobalIntraOpNumThreads(4);
      threadingOptions.setGlobalInterOpNumThreads(2);

      OrtEnvironment.getEnvironment(
          ai.onnxruntime.OrtLoggingLevel.ORT_LOGGING_LEVEL_WARNING,
          "alexandria",
          threadingOptions);

      log.info(
          "ONNX Runtime initialized: spinning=off, intra-op=4, inter-op=2");
    } catch (OrtException e) {
      throw new RuntimeException("Failed to configure ONNX Runtime threading", e);
    }
  }
}
```

Per user decisions: allow_spinning=0 (setGlobalSpinControl(false)), 4 intra-op threads, 2 inter-op threads. Single config for both embedding and scoring model sessions.

Add `@SuppressWarnings("NullAway")` if needed on the class (OrtEnvironment methods may trigger NullAway warnings).

Follow project conventions: constructor injection only (no fields here since BeanFactoryPostProcessor), no @Autowired, proper Javadoc.
  </action>
  <verify>
Run `./quality.sh test` to ensure all tests pass. The ONNX environment initialization should not break any existing tests since tests typically mock the embedding model. Run `./gradlew compileJava` to verify compilation.
  </verify>
  <done>OnnxRuntimeConfig exists as a BeanFactoryPostProcessor that configures OrtEnvironment with spinning=off, intra-op=4, inter-op=2 before any ONNX models load.</done>
</task>

<task type="auto">
  <name>Task 2: Add BGE query prefix to search embedding and update tests</name>
  <files>src/main/java/dev/alexandria/search/SearchService.java, src/test/java/dev/alexandria/search/SearchServiceTest.java</files>
  <action>
In `SearchService.java`, add a constant for the BGE query prefix and prepend it to the query before embedding. The prefix is recommended by the BGE model documentation (visible in the BgeSmallEnV15QuantizedEmbeddingModel Javadoc): "Represent this sentence for searching relevant passages: "

**Important:** This prefix is ONLY for search queries, NOT for documents at ingestion time. The ingestion pipeline uses `embeddingModel.embed()` directly on document text and should NOT be modified.

Changes to `SearchService.java`:
1. Add a package-visible constant: `static final String BGE_QUERY_PREFIX = "Represent this sentence for searching relevant passages: ";`
2. In the `search()` method, change:
   ```java
   Embedding queryEmbedding = embeddingModel.embed(request.query()).content();
   ```
   to:
   ```java
   Embedding queryEmbedding = embeddingModel.embed(BGE_QUERY_PREFIX + request.query()).content();
   ```

Changes to `SearchServiceTest.java`:
1. Update `stubEmbeddingModel(String query)` to use `SearchService.BGE_QUERY_PREFIX + query`:
   ```java
   private void stubEmbeddingModel(String query) {
     when(embeddingModel.embed(SearchService.BGE_QUERY_PREFIX + query))
         .thenReturn(Response.from(DUMMY_EMBEDDING));
   }
   ```
   This way ALL existing tests automatically test with the prefix since they all use `stubEmbeddingModel("test query")`.

2. Add one explicit test verifying the prefix is applied:
   ```java
   @Test
   void searchPrependsQueryPrefixBeforeEmbedding() {
     stubEmbeddingModel("my search");
     stubStoreWithOneMatch();
     stubRerankerReturnsEmpty();

     searchService.search(new SearchRequest("my search"));

     verify(embeddingModel).embed(SearchService.BGE_QUERY_PREFIX + "my search");
   }
   ```

Follow project testing conventions: AAA structure, descriptive test names, behavior-based testing.
  </action>
  <verify>
Run `./quality.sh test` — all tests must pass. Verify with `grep -n "BGE_QUERY_PREFIX" src/main/java/dev/alexandria/search/SearchService.java` that the prefix constant exists and is used. Verify with `grep -n "BGE_QUERY_PREFIX" src/test/java/dev/alexandria/search/SearchServiceTest.java` that the test verifies prefix behavior.
  </verify>
  <done>SearchService prepends "Represent this sentence for searching relevant passages: " to all search queries before embedding. Tests verify the prefix is applied. Ingestion paths are unchanged.</done>
</task>

</tasks>

<verification>
1. `./gradlew compileJava` compiles without errors (OnnxRuntimeConfig + SearchService changes)
2. `./quality.sh test` passes (all unit tests including updated SearchServiceTest)
3. `OnnxRuntimeConfig` is a `BeanFactoryPostProcessor` that configures OrtEnvironment before model loading
4. `SearchService` prepends BGE query prefix to search queries only
5. `SearchServiceTest` verifies prefix behavior explicitly
</verification>

<success_criteria>
- ONNX Runtime configured with spinning disabled (setGlobalSpinControl(false)), 4 intra-op and 2 inter-op threads
- Search queries prepend BGE prefix before embedding, improving retrieval relevance
- Ingestion pipeline unchanged (no prefix on document embeddings)
- All existing and new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-performance-quick-wins/12-02-SUMMARY.md`
</output>

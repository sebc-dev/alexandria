---
phase: 05-mcp-server
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/test/java/dev/alexandria/mcp/TokenBudgetTruncatorTest.java
  - src/test/java/dev/alexandria/mcp/McpToolServiceTest.java
  - .mcp.json
autonomous: true
requirements:
  - MCP-02
  - MCP-03
  - MCP-04
  - INFRA-03

must_haves:
  truths:
    - "TokenBudgetTruncator correctly formats and truncates results to token budget"
    - "McpToolService delegates to correct services and handles all error cases"
    - "Claude Code can connect via .mcp.json stdio configuration"
  artifacts:
    - path: "src/test/java/dev/alexandria/mcp/TokenBudgetTruncatorTest.java"
      provides: "Unit tests for token budget truncation logic"
      contains: "truncat"
    - path: "src/test/java/dev/alexandria/mcp/McpToolServiceTest.java"
      provides: "Unit tests for all 6 MCP tool methods"
      contains: "searchDocs"
    - path: ".mcp.json"
      provides: "Claude Code MCP stdio configuration"
      contains: "mcpServers"
  key_links:
    - from: "src/test/java/dev/alexandria/mcp/McpToolServiceTest.java"
      to: "McpToolService"
      via: "direct method calls with mocked dependencies"
      pattern: "McpToolService"
    - from: ".mcp.json"
      to: "application-stdio.yml"
      via: "spring.profiles.active=stdio in java args"
      pattern: "spring\\.profiles\\.active=stdio"
---

<objective>
Add comprehensive unit tests for the MCP adapter layer and create the .mcp.json Claude Code integration configuration.

Purpose: Validate that TokenBudgetTruncator correctly enforces token budgets and McpToolService correctly delegates to feature services, handles errors structurally, and produces well-formatted output. The .mcp.json file enables Claude Code to connect to Alexandria via stdio transport.

Output: 2 test files + .mcp.json configuration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-mcp-server/05-RESEARCH.md
@.planning/phases/05-mcp-server/05-01-SUMMARY.md

Key files to reference:
@src/main/java/dev/alexandria/mcp/TokenBudgetTruncator.java
@src/main/java/dev/alexandria/mcp/McpToolService.java
@src/main/java/dev/alexandria/search/SearchResult.java
@src/main/java/dev/alexandria/source/Source.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for TokenBudgetTruncator and McpToolService</name>
  <files>
    src/test/java/dev/alexandria/mcp/TokenBudgetTruncatorTest.java
    src/test/java/dev/alexandria/mcp/McpToolServiceTest.java
  </files>
  <action>
Create `TokenBudgetTruncatorTest` in `dev.alexandria.mcp` (unit test, no Spring context):

Test the pure logic of TokenBudgetTruncator. Construct directly with a token budget value.

Test cases (camelCase names per project convention):
1. `singleResultWithinBudgetIsIncluded` -- one result fits, output contains it
2. `multipleResultsTruncatedWhenBudgetExceeded` -- 3 results where only 2 fit within budget, verify only 2 appear
3. `emptyResultListReturnsEmptyString` -- empty list input returns empty/no-results string
4. `firstResultAlwaysIncludedEvenIfExceedsBudget` -- single large result exceeding budget is still included (at least partially)
5. `outputFormattingIncludesSourceUrlAndSectionPath` -- verify formatted output contains source URL and section path
6. `tokenEstimationUsesCharsDiv4` -- verify a known string length produces expected token estimate (e.g., 400 chars = 100 tokens)

Create `McpToolServiceTest` in `dev.alexandria.mcp` (unit test, no Spring context):

Mock dependencies: `SearchService`, `SourceRepository`, `TokenBudgetTruncator`.
Construct `McpToolService` directly with mocks.

Test cases for `searchDocs`:
1. `searchDocsReturnsFormattedResults` -- stub SearchService to return results, stub truncator, verify output is truncator's return value
2. `searchDocsWithNullQueryReturnsError` -- null query returns "Error:" prefixed string
3. `searchDocsWithBlankQueryReturnsError` -- blank query returns "Error:" prefixed string
4. `searchDocsWithNoResultsReturnsNotFoundMessage` -- empty result list returns "No results found" message
5. `searchDocsDefaultsMaxResultsTo10` -- when maxResults is null, verify SearchRequest is created with 10
6. `searchDocsClampsMaxResultsTo50` -- when maxResults is 100, verify clamped to 50
7. `searchDocsHandlesExceptionGracefully` -- SearchService throws RuntimeException, verify "Error:" return

Test cases for `listSources`:
8. `listSourcesFormatsAllSources` -- stub repo with 2 sources, verify formatted output contains both
9. `listSourcesWithNoSourcesReturnsEmptyMessage` -- empty repo returns "No documentation sources" message
10. `listSourcesHandlesExceptionGracefully` -- repo throws, returns "Error:" string

Test cases for `addSource`:
11. `addSourceCreatesPendingSource` -- verify sourceRepository.save() called with PENDING status Source
12. `addSourceWithBlankUrlReturnsError` -- blank URL returns "Error:" string

Test cases for `removeSource`:
13. `removeSourceDeletesById` -- valid UUID string, verify deleteById called
14. `removeSourceWithInvalidUuidReturnsError` -- "not-a-uuid" returns "Error:" string

Test cases for `crawlStatus`:
15. `crawlStatusReturnsSourceInfo` -- stub repo findById with source, verify status info returned
16. `crawlStatusWithUnknownSourceReturnsError` -- findById returns empty, returns error message

Test cases for `recrawlSource`:
17. `recrawlSourceReturnsStubMessage` -- existing source returns "will be available" message
18. `recrawlSourceWithUnknownSourceReturnsError` -- not found returns error

All test doubles follow project conventions:
- Use Mockito `@Mock` / `@ExtendWith(MockitoExtension.class)` pattern
- Mock only real external-facing dependencies (SearchService, SourceRepository are feature services -- acceptable to mock per adapter test pattern)
- Use `given()...willReturn()` for stubs
- Verify error messages start with "Error:" prefix
- Use test fixture builders (SourceBuilder) where applicable

All tests follow AAA structure with blank line separators.
  </action>
  <verify>
    `./quality.sh test` passes. `grep -c "@Test" src/test/java/dev/alexandria/mcp/TokenBudgetTruncatorTest.java` shows ~6 tests. `grep -c "@Test" src/test/java/dev/alexandria/mcp/McpToolServiceTest.java` shows ~18 tests. No test uses snake_case naming.
  </verify>
  <done>
    TokenBudgetTruncator has 6 unit tests covering budget enforcement, formatting, edge cases. McpToolService has 18 unit tests covering all 6 tool methods including happy paths, validation, error handling. All tests pass without Spring context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create .mcp.json and verify full quality gate</name>
  <files>
    .mcp.json
  </files>
  <action>
Create `.mcp.json` at project root for Claude Code integration (INFRA-03):

```json
{
  "mcpServers": {
    "alexandria": {
      "type": "stdio",
      "command": "java",
      "args": [
        "-Dspring.profiles.active=stdio",
        "-jar",
        "build/libs/alexandria-0.0.1-SNAPSHOT.jar"
      ],
      "env": {
        "DB_HOST": "localhost",
        "DB_PORT": "5432",
        "DB_NAME": "alexandria",
        "DB_USER": "alexandria",
        "DB_PASSWORD": "alexandria_dev"
      }
    }
  }
}
```

Note: The jar path is relative to the project root. Users running `claude` from the project root will have this resolve correctly. The `application-stdio.yml` profile already configures `spring.ai.mcp.server.stdio: true`, `spring.main.web-application-type: none`, `banner-mode: off`, and blank console log pattern to avoid stdout corruption.

Run full quality gate:
- `./quality.sh test` -- all unit tests pass (including new mcp tests)
- `./quality.sh spotbugs` -- no new findings in mcp package
- `./quality.sh arch` -- ArchUnit passes (mcp adapter -> feature services is valid direction)
- Verify no `System.out.println` in any mcp/ file
  </action>
  <verify>
    `./quality.sh test` passes. `./quality.sh arch` passes. `cat .mcp.json` shows valid JSON with stdio config. `./quality.sh spotbugs` has no new findings.
  </verify>
  <done>
    .mcp.json exists at project root with correct stdio transport configuration. All quality gates pass. Phase 5 is feature-complete: 6 tools registered, token budget enforced, errors structured, .mcp.json ready for Claude Code.
  </done>
</task>

</tasks>

<verification>
1. `./quality.sh test` passes -- all unit tests green including ~24 new tests
2. `./quality.sh arch` passes -- mcp adapter dependencies are valid
3. `./quality.sh spotbugs` -- no new findings in mcp package
4. `.mcp.json` exists with valid JSON, stdio transport, correct jar path
5. Test coverage: every tool method has happy path + error handling tests
6. No snake_case test method names (camelCase convention)
</verification>

<success_criteria>
- TokenBudgetTruncatorTest: ~6 tests covering truncation logic, formatting, edge cases
- McpToolServiceTest: ~18 tests covering all 6 tools (happy path + validation + error handling)
- .mcp.json at project root with stdio transport config pointing to fat jar
- All quality gates pass: `./quality.sh test`, `./quality.sh arch`, `./quality.sh spotbugs`
- Zero regressions on existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-mcp-server/05-02-SUMMARY.md`
</output>

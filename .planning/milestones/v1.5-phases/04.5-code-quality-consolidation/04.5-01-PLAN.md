---
phase: 04.5-code-quality-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/dev/alexandria/crawl/CrawlResult.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiRequest.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiResponse.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiPageResult.java
  - src/main/java/dev/alexandria/ingestion/prechunked/PreChunkedRequest.java
  - src/main/java/dev/alexandria/ingestion/IngestionService.java
  - src/main/java/dev/alexandria/ingestion/prechunked/PreChunkedImporter.java
  - src/main/java/dev/alexandria/search/SearchService.java
  - config/spotbugs/exclude-filter.xml
  - build.gradle.kts
  - src/test/java/dev/alexandria/fixture/SourceBuilder.java
  - src/test/java/dev/alexandria/fixture/DocumentChunkBuilder.java
requirements: []
autonomous: true

must_haves:
  truths:
    - "SpotBugs report has zero EI_EXPOSE_REP/EI_EXPOSE_REP2 findings on records with List fields"
    - "SpotBugs report has zero CT_CONSTRUCTOR_THROW findings on JPA entities"
    - "Spring bean constructor injections are excluded from SpotBugs EI_EXPOSE_REP2 via filter"
    - "spring-retry and spring-boot-starter-aop dependencies are removed from build"
    - "Test fixture builders exist for Source and DocumentChunk JPA entities"
  artifacts:
    - path: "config/spotbugs/exclude-filter.xml"
      provides: "SpotBugs exclusions for Spring beans and JPA entity constructors"
    - path: "src/test/java/dev/alexandria/fixture/SourceBuilder.java"
      provides: "Lightweight test builder for Source entity"
    - path: "src/test/java/dev/alexandria/fixture/DocumentChunkBuilder.java"
      provides: "Lightweight test builder for DocumentChunk entity"
  key_links:
    - from: "records (CrawlResult, Crawl4AiRequest, etc.)"
      to: "SpotBugs report"
      via: "List.copyOf() defensive copies in compact constructors"
      pattern: "List\\.copyOf\\("
---

<objective>
Fix all 23 SpotBugs findings, remove unused Gradle dependencies, and create test fixture builders for JPA entities.

Purpose: Establish a clean SpotBugs baseline and shared test infrastructure before adding new tests in subsequent plans.
Output: Zero SpotBugs findings (after exclusions), leaner dependency set, reusable fixture builders.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.5-code-quality-consolidation/04.5-RESEARCH.md
@config/spotbugs/exclude-filter.xml
@build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix SpotBugs findings (23 total: defensive copies, exclusion filter)</name>
  <files>
    src/main/java/dev/alexandria/crawl/CrawlResult.java
    src/main/java/dev/alexandria/crawl/Crawl4AiRequest.java
    src/main/java/dev/alexandria/crawl/Crawl4AiResponse.java
    src/main/java/dev/alexandria/crawl/Crawl4AiPageResult.java
    src/main/java/dev/alexandria/ingestion/prechunked/PreChunkedRequest.java
    config/spotbugs/exclude-filter.xml
  </files>
  <action>
    Fix all 23 SpotBugs findings in three groups:

    **EI_EXPOSE_REP2 + EI_EXPOSE_REP on records (14+9 = 23 findings for records):**
    Add compact constructors with `List.copyOf()` to every record that has a `List` parameter. Use null-safe pattern to avoid Jackson NPE:
    ```java
    public CrawlResult {
        internalLinks = internalLinks == null ? List.of() : List.copyOf(internalLinks);
    }
    ```
    Apply to: CrawlResult, Crawl4AiRequest, Crawl4AiResponse, Crawl4AiPageResult, PreChunkedRequest. Check each record's List fields.

    **EI_EXPOSE_REP2 on Spring service constructors (IngestionService, SearchService, PreChunkedImporter):**
    These are false positives (Spring beans are singletons). Add exclusions to `config/spotbugs/exclude-filter.xml`:
    ```xml
    <Match>
        <Bug pattern="EI_EXPOSE_REP2"/>
        <Or>
            <Class name="dev.alexandria.search.SearchService"/>
            <Class name="dev.alexandria.ingestion.IngestionService"/>
            <Class name="dev.alexandria.ingestion.prechunked.PreChunkedImporter"/>
        </Or>
        <Method name="&lt;init&gt;"/>
    </Match>
    ```

    **CT_CONSTRUCTOR_THROW on JPA entities (Source, DocumentChunk, IngestionState):**
    These are false positives (JPA requires non-final classes, @PrePersist is by design). Add exclusion:
    ```xml
    <Match>
        <Bug pattern="CT_CONSTRUCTOR_THROW"/>
        <Or>
            <Class name="dev.alexandria.source.Source"/>
            <Class name="dev.alexandria.document.DocumentChunk"/>
            <Class name="dev.alexandria.ingestion.IngestionState"/>
        </Or>
    </Match>
    ```

    Also add EI_EXPOSE_REP exclusion for JPA entity getters returning Instant (Instant is immutable, SpotBugs reports incorrectly):
    ```xml
    <Match>
        <Bug pattern="EI_EXPOSE_REP"/>
        <Or>
            <Class name="dev.alexandria.source.Source"/>
            <Class name="dev.alexandria.document.DocumentChunk"/>
            <Class name="dev.alexandria.ingestion.IngestionState"/>
        </Or>
    </Match>
    ```
  </action>
  <verify>
    Run `./quality.sh spotbugs` and verify zero findings in the report. Run `./quality.sh test` to confirm no regressions from defensive copies.
  </verify>
  <done>SpotBugs report shows 0 bugs. All existing unit tests pass. Records with List fields use List.copyOf() in compact constructors.</done>
</task>

<task type="auto">
  <name>Task 2: Remove unused Gradle dependencies and create test fixture builders</name>
  <files>
    build.gradle.kts
    src/test/java/dev/alexandria/fixture/SourceBuilder.java
    src/test/java/dev/alexandria/fixture/DocumentChunkBuilder.java
  </files>
  <action>
    **Remove unused dependencies from build.gradle.kts:**
    Delete these two lines (no @Retryable/@EnableRetry usage found in codebase):
    - `implementation(libs.spring.boot.starter.aop)`
    - `implementation(libs.spring.retry)`

    Also remove corresponding entries from `gradle/libs.versions.toml` if they exist as standalone entries.

    **Create test fixture builders in `src/test/java/dev/alexandria/fixture/` package:**

    **SourceBuilder.java:**
    Lightweight builder for Source JPA entity. Read Source.java to understand constructor and fields.
    ```java
    public final class SourceBuilder {
        private String url = "https://docs.example.com";
        private String name = "Example Docs";
        // ... other fields with sensible defaults

        public SourceBuilder url(String url) { this.url = url; return this; }
        public SourceBuilder name(String name) { this.name = name; return this; }
        // ... other fluent setters

        public Source build() { return new Source(url, name); }
    }
    ```

    **DocumentChunkBuilder.java:**
    Lightweight builder for DocumentChunk JPA entity. Read DocumentChunk.java to understand constructor and fields.
    Similar pattern with sensible defaults for all required fields.

    Per user decision: builders for JPA entities only (mutable state). Records are constructed inline.
  </action>
  <verify>
    Run `./gradlew dependencies --configuration compileClasspath` and verify spring-retry and spring-boot-starter-aop no longer appear. Run `./quality.sh test` to confirm compilation succeeds with builders and no dependency issues.
  </verify>
  <done>spring-retry and spring-boot-starter-aop removed from build. SourceBuilder and DocumentChunkBuilder exist in test fixture package with sensible defaults and fluent API. All tests pass.</done>
</task>

</tasks>

<verification>
- `./quality.sh spotbugs` reports 0 bugs
- `./quality.sh test` passes all existing unit tests
- `./gradlew dependencies --configuration compileClasspath | grep -i retry` returns nothing
- SourceBuilder and DocumentChunkBuilder compile and are importable from test source sets
</verification>

<success_criteria>
SpotBugs findings reduced from 23 to 0. Unused dependencies removed. Test fixture builders available for subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-code-quality-consolidation/04.5-01-SUMMARY.md`
</output>

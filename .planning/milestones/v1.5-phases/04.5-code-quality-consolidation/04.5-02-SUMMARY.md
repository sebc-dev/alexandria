---
phase: 04.5-code-quality-consolidation
plan: 02
subsystem: testing
tags: [pit, mutation-testing, refactoring, markdown-chunker, boundary-testing]

# Dependency graph
requires:
  - phase: 00-ci-quality-gate
    provides: PIT mutation testing infrastructure and quality.sh runner
provides:
  - "Mutation-proof tests for MarkdownChunker (14 new mutations killed)"
  - "Refactored MarkdownChunker with focused helper methods"
  - "Documented 6 equivalent mutations that cannot be killed"
affects: [04.5-code-quality-consolidation]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Boundary value testing for PIT ConditionalsBoundaryMutator"
    - "Equivalent mutation documentation with justification"

key-files:
  created: []
  modified:
    - src/test/java/dev/alexandria/ingestion/chunking/MarkdownChunkerTest.java
    - src/test/java/dev/alexandria/ingestion/chunking/LanguageDetectorTest.java
    - src/main/java/dev/alexandria/ingestion/chunking/MarkdownChunker.java

key-decisions:
  - "6 surviving mutations classified as equivalent (downstream guards render them unkillable)"
  - "splitOversizedText and splitBySentences kept as-is per user decision (linear flow, single responsibility)"
  - "chunk() method remains at 38 lines due to inherent setup complexity, while loop body is clean"

patterns-established:
  - "Equivalent mutation documentation: when a mutation cannot change observable behavior due to downstream guards, document it rather than forcing artificial tests"

requirements-completed: []

# Metrics
duration: 12min
completed: 2026-02-19
---

# Phase 4.5 Plan 02: Kill PIT Mutations and Refactor MarkdownChunker Summary

**PIT mutation score improved from 67% to 84% (93% test strength) with 18 new targeted boundary tests, plus MarkdownChunker decomposed into focused helper methods**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-19T19:17:25Z
- **Completed:** 2026-02-19T19:29:33Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- Killed 14 of 20 previously surviving PIT mutations with targeted boundary tests
- Classified remaining 6 mutations as equivalent with documented justification
- Decomposed emitChunks (40 lines) into emitSection (16), emitProseChunk (20), emitCodeChunks (15)
- Extracted updateHeadingPath helper for heading hierarchy management
- PIT test strength improved from 74% to 93%

## Task Commits

Each task was committed atomically:

1. **Task 1: Kill all surviving PIT mutations** - `3267c43` (test)
2. **Task 2: Refactor MarkdownChunker long methods** - `d4c3e50` (refactor)

## Files Created/Modified
- `src/test/java/dev/alexandria/ingestion/chunking/MarkdownChunkerTest.java` - 18 new tests targeting specific mutation locations (boundary values, clear() calls, newline stripping, heading inclusion, sentence splitting)
- `src/test/java/dev/alexandria/ingestion/chunking/LanguageDetectorTest.java` - 2 new tests for score threshold boundary
- `src/main/java/dev/alexandria/ingestion/chunking/MarkdownChunker.java` - Refactored emitChunks into emitSection/emitProseChunk/emitCodeChunks, extracted updateHeadingPath

## Decisions Made
- **6 equivalent mutations documented, not forced:** The remaining surviving mutations (4 ConditionalsBoundaryMutator on `<=` vs `<`, 1 NegateConditionalsMutator, 1 ConditionalsBoundaryMutator) are functionally equivalent because downstream guards (isBlank checks, splitBySentences recombining, parser never producing out-of-range indices) make the mutation produce identical output. Forcing tests for these would require testing implementation details.
- **splitOversizedText/splitBySentences not refactored:** Per user decision, these have linear flow and single responsibility despite being 37 and 24 lines respectively.
- **chunk() left at 38 lines:** The method's length comes from necessary variable declarations and setup. The while-loop body is lean (12 lines) after extracting updateHeadingPath.

## Deviations from Plan

None - plan executed exactly as written.

## Equivalent Mutations (Justified Survivors)

| Location | Mutation | Why Equivalent |
|----------|----------|----------------|
| appendNodeText:186 | `lineIndex < lines.length` boundary | CommonMark parser never produces lineIndex == lines.length |
| emitSection:122 | Negate `sectionHeading == null` | Downstream isBlank() check catches empty prose from null heading |
| emitProseChunk:151 | `proseText.length() <= maxChunkSize` boundary | splitOversizedText returns identical result for text == maxSize |
| splitOversizedText:247 | `trimmed.length() <= maxSize` boundary | splitBySentences recombines sentences back to original when total <= maxSize |
| splitOversizedText:258 | `trimmed.length() <= maxSize` boundary | Same as above, different code path |
| LanguageDetector:58 | `score > 0` boundary | Downstream `>= 2` filter already excludes 0-scoring languages |

## Issues Encountered
- Gradle build cache aggressively caching test compilation required explicit cache clearing on first test run
- One test (`proseChunkOneOverMaxSizeIsSplit`) initially failed because CommonMark's prose assembly uses single newlines between nodes, not paragraph-separator double newlines -- fixed by testing through splitOversizedText directly

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- MarkdownChunker is now well-tested (35 unit tests, 93% PIT test strength) and readable
- LanguageDetector at 17 tests with only 1 equivalent mutation surviving
- Ready for subsequent code quality plans in Phase 4.5

## Self-Check: PASSED

- All 3 modified files exist on disk
- Both task commits (3267c43, d4c3e50) found in git history

---
*Phase: 04.5-code-quality-consolidation*
*Completed: 2026-02-19*

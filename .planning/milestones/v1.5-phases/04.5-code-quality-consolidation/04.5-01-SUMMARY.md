---
phase: 04.5-code-quality-consolidation
plan: 01
subsystem: testing
tags: [spotbugs, defensive-copy, gradle, test-fixtures]

# Dependency graph
requires:
  - phase: 03-web-crawling
    provides: "Record types (CrawlResult, Crawl4AiRequest, etc.) and JPA entities with SpotBugs findings"
provides:
  - "Zero SpotBugs findings baseline with defensive copies and exclusion filter"
  - "Leaner dependency set (spring-retry and spring-boot-starter-aop removed)"
  - "Reusable test fixture builders for Source and DocumentChunk entities"
affects: [04.5-code-quality-consolidation, testing]

# Tech tracking
tech-stack:
  added: []
  patterns: [defensive-copy-compact-constructor, spotbugs-exclusion-filter, test-fixture-builder]

key-files:
  created:
    - src/test/java/dev/alexandria/fixture/SourceBuilder.java
    - src/test/java/dev/alexandria/fixture/DocumentChunkBuilder.java
  modified:
    - config/spotbugs/exclude-filter.xml
    - src/main/java/dev/alexandria/crawl/CrawlResult.java
    - src/main/java/dev/alexandria/crawl/Crawl4AiRequest.java
    - src/main/java/dev/alexandria/crawl/Crawl4AiResponse.java
    - src/main/java/dev/alexandria/crawl/Crawl4AiPageResult.java
    - src/main/java/dev/alexandria/crawl/PageDiscoveryService.java
    - src/main/java/dev/alexandria/ingestion/prechunked/PreChunkedRequest.java
    - build.gradle.kts
    - gradle/libs.versions.toml

key-decisions:
  - "Deep-copy Map<String, List<>> via Collectors.toUnmodifiableMap with List.copyOf on values for Crawl4AiPageResult.links"
  - "Exclude Crawl4AiPageResult.links() EI_EXPOSE_REP since SpotBugs cannot trace Collectors.toUnmodifiableMap"
  - "Exclude MarkdownChunker CT_CONSTRUCTOR_THROW (Spring component with constructor validation, by design)"
  - "Exclude Crawl4AiClient EI_EXPOSE_REP2 on constructor (Spring singleton bean)"

patterns-established:
  - "Defensive copy pattern: records with List/Map fields use compact constructors with null-safe copyOf"
  - "SpotBugs exclusion pattern: Spring bean constructors excluded from EI_EXPOSE_REP2, JPA entities from CT_CONSTRUCTOR_THROW and EI_EXPOSE_REP"
  - "Test fixture builder pattern: final class with sensible defaults and fluent API for JPA entities"

requirements-completed: []

# Metrics
duration: 5min
completed: 2026-02-19
---

# Phase 4.5 Plan 01: SpotBugs Baseline & Test Fixtures Summary

**Zero SpotBugs findings via defensive copy compact constructors and targeted exclusion filter, plus SourceBuilder/DocumentChunkBuilder test fixtures and spring-retry removal**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-19T19:17:09Z
- **Completed:** 2026-02-19T19:22:23Z
- **Tasks:** 2
- **Files modified:** 11

## Accomplishments
- SpotBugs findings reduced from 23+ to 0 (defensive copies on 6 records, exclusion filter for Spring beans, JPA entities, and MarkdownChunker)
- Removed unused spring-boot-starter-aop and spring-retry dependencies from build
- Created SourceBuilder and DocumentChunkBuilder test fixture builders with sensible defaults and fluent API

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix SpotBugs findings** - `71aeaee` (fix)
2. **Task 2: Remove unused dependencies and create test fixture builders** - `417cc74` (chore)

## Files Created/Modified
- `config/spotbugs/exclude-filter.xml` - SpotBugs exclusions for Spring beans, JPA entities, MarkdownChunker, Crawl4AiPageResult.links()
- `src/main/java/dev/alexandria/crawl/CrawlResult.java` - Defensive copy compact constructor for internalLinks
- `src/main/java/dev/alexandria/crawl/Crawl4AiRequest.java` - Defensive copy compact constructor for urls, browser_config, crawler_config
- `src/main/java/dev/alexandria/crawl/Crawl4AiResponse.java` - Defensive copy compact constructor for results
- `src/main/java/dev/alexandria/crawl/Crawl4AiPageResult.java` - Deep defensive copy compact constructor for links Map
- `src/main/java/dev/alexandria/crawl/PageDiscoveryService.java` - Defensive copy compact constructor for DiscoveryResult.urls
- `src/main/java/dev/alexandria/ingestion/prechunked/PreChunkedRequest.java` - Defensive copy compact constructor for chunks
- `build.gradle.kts` - Removed spring-boot-starter-aop and spring-retry
- `gradle/libs.versions.toml` - Removed spring-retry and spring-boot-starter-aop library entries
- `src/test/java/dev/alexandria/fixture/SourceBuilder.java` - Fluent builder for Source entity with sensible defaults
- `src/test/java/dev/alexandria/fixture/DocumentChunkBuilder.java` - Fluent builder for DocumentChunk entity with sensible defaults

## Decisions Made
- Deep-copied `Map<String, List<Crawl4AiLink>>` in Crawl4AiPageResult using `Collectors.toUnmodifiableMap` with `List.copyOf` on values, plus SpotBugs exclusion since static analysis cannot trace the unmodifiable collector
- Added Crawl4AiClient and MarkdownChunker to SpotBugs exclusion filter (not in original plan but discovered as additional findings during execution)
- Added PageDiscoveryService.DiscoveryResult defensive copy (inner record not enumerated in plan but discovered during SpotBugs run)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed additional SpotBugs findings not enumerated in plan**
- **Found during:** Task 1 (SpotBugs verification)
- **Issue:** Plan enumerated 23 findings but actual report showed additional findings on Crawl4AiClient (EI_EXPOSE_REP2), PageDiscoveryService.DiscoveryResult (EI_EXPOSE_REP + EI_EXPOSE_REP2), MarkdownChunker (2x CT_CONSTRUCTOR_THROW), and Crawl4AiPageResult.links() (EI_EXPOSE_REP)
- **Fix:** Added Crawl4AiClient to Spring bean exclusion, MarkdownChunker to CT_CONSTRUCTOR_THROW exclusion, Crawl4AiPageResult.links() to EI_EXPOSE_REP exclusion, and defensive copy to PageDiscoveryService.DiscoveryResult
- **Files modified:** config/spotbugs/exclude-filter.xml, src/main/java/dev/alexandria/crawl/PageDiscoveryService.java
- **Verification:** SpotBugs reports 0 bugs
- **Committed in:** 71aeaee (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - additional SpotBugs findings in same scope)
**Impact on plan:** Essential for achieving zero-findings goal. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- SpotBugs baseline established at zero findings for subsequent plans
- Test fixture builders available for Source and DocumentChunk entities
- Leaner dependency set ready for continued development

---
## Self-Check: PASSED

All created files exist. All commit hashes verified.

---
*Phase: 04.5-code-quality-consolidation*
*Completed: 2026-02-19*

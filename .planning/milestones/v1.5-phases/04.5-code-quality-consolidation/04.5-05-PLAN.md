---
phase: 04.5-code-quality-consolidation
plan: 05
type: execute
wave: 3
depends_on: ["04.5-01", "04.5-02", "04.5-03", "04.5-04"]
files_modified:
  - src/main/java/dev/alexandria/source/Source.java
  - src/main/java/dev/alexandria/source/SourceRepository.java
  - src/main/java/dev/alexandria/source/SourceStatus.java
  - src/main/java/dev/alexandria/document/DocumentChunk.java
  - src/main/java/dev/alexandria/document/DocumentChunkRepository.java
  - src/main/java/dev/alexandria/ingestion/IngestionState.java
  - src/main/java/dev/alexandria/ingestion/IngestionStateRepository.java
  - src/main/java/dev/alexandria/config/EmbeddingConfig.java
  - src/main/java/dev/alexandria/config/GlobalExceptionHandler.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiConfig.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiClient.java
  - src/main/java/dev/alexandria/crawl/CrawlResult.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiResponse.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiPageResult.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiRequest.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiLink.java
  - src/main/java/dev/alexandria/crawl/Crawl4AiMarkdown.java
  - src/main/java/dev/alexandria/AlexandriaApplication.java
  - src/test/java/dev/alexandria/crawl/UrlNormalizerTest.java
  - src/test/java/dev/alexandria/search/SearchRequestTest.java
  - src/test/java/dev/alexandria/search/SearchServiceTest.java
  - src/integrationTest/java/dev/alexandria/BaseIntegrationTest.java
  - src/integrationTest/java/dev/alexandria/EmbeddingStoreIT.java
  - src/integrationTest/java/dev/alexandria/JpaSchemaDriftIT.java
  - src/integrationTest/java/dev/alexandria/SmokeIntegrationTest.java
  - src/integrationTest/java/dev/alexandria/crawl/Crawl4AiClientIT.java
  - src/integrationTest/java/dev/alexandria/crawl/CrawlServiceIT.java
  - src/integrationTest/java/dev/alexandria/ingestion/IngestionServiceIT.java
  - src/integrationTest/java/dev/alexandria/ingestion/prechunked/PreChunkedImporterIT.java
  - src/integrationTest/java/dev/alexandria/ingestion/prechunked/PreChunkedImporterRollbackIT.java
  - src/integrationTest/java/dev/alexandria/search/HybridSearchIT.java
requirements: []
autonomous: true

must_haves:
  truths:
    - "All 18 classes identified in research have Javadoc per the documentation rules"
    - "All ~46 snake_case test method names are renamed to camelCase"
    - "cleanStore() @BeforeEach is consolidated in BaseIntegrationTest"
    - "All quality gates pass: ./quality.sh all --with-integration"
    - "No unused imports remain in any modified file"
  artifacts:
    - path: "src/integrationTest/java/dev/alexandria/BaseIntegrationTest.java"
      provides: "Consolidated cleanStore() @BeforeEach for all ITs using EmbeddingStore"
  key_links:
    - from: "All test files"
      to: "Test method naming convention"
      via: "camelCase rename (snake_case removed)"
      pattern: "void [a-z]+[A-Z]"
---

<objective>
Complete the final cleanup pass: add Javadoc to 18 classes, harmonize all test names to camelCase, consolidate integration test duplicates, and perform dead code/import cleanup.

Purpose: This plan touches many files with small changes. Running it last avoids merge conflicts with plans 01-04 that create and modify test files. It ensures the entire codebase is consistent and documented before Phase 5 (MCP Server).
Output: Fully documented classes, uniform test naming, consolidated IT infrastructure, clean imports.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.5-code-quality-consolidation/04.5-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Javadoc to 18 undocumented classes and consolidate integration tests</name>
  <files>
    src/main/java/dev/alexandria/source/Source.java
    src/main/java/dev/alexandria/source/SourceRepository.java
    src/main/java/dev/alexandria/source/SourceStatus.java
    src/main/java/dev/alexandria/document/DocumentChunk.java
    src/main/java/dev/alexandria/document/DocumentChunkRepository.java
    src/main/java/dev/alexandria/ingestion/IngestionState.java
    src/main/java/dev/alexandria/ingestion/IngestionStateRepository.java
    src/main/java/dev/alexandria/config/EmbeddingConfig.java
    src/main/java/dev/alexandria/config/GlobalExceptionHandler.java
    src/main/java/dev/alexandria/crawl/Crawl4AiConfig.java
    src/main/java/dev/alexandria/crawl/Crawl4AiClient.java
    src/main/java/dev/alexandria/crawl/CrawlResult.java
    src/main/java/dev/alexandria/crawl/Crawl4AiResponse.java
    src/main/java/dev/alexandria/crawl/Crawl4AiPageResult.java
    src/main/java/dev/alexandria/crawl/Crawl4AiRequest.java
    src/main/java/dev/alexandria/crawl/Crawl4AiLink.java
    src/main/java/dev/alexandria/crawl/Crawl4AiMarkdown.java
    src/main/java/dev/alexandria/AlexandriaApplication.java
    src/integrationTest/java/dev/alexandria/BaseIntegrationTest.java
    src/integrationTest/java/dev/alexandria/EmbeddingStoreIT.java
    src/integrationTest/java/dev/alexandria/ingestion/IngestionServiceIT.java
    src/integrationTest/java/dev/alexandria/ingestion/prechunked/PreChunkedImporterIT.java
    src/integrationTest/java/dev/alexandria/ingestion/prechunked/PreChunkedImporterRollbackIT.java
  </files>
  <action>
    **Javadoc (18 classes):**
    Apply the user's Javadoc rules from CONTEXT.md:
    - ALWAYS: classes/interfaces (role, responsibility, architectural context), public API methods (intention, contract), @param with business semantics, @return, @throws, constraints
    - NEVER: getters/setters triviaux, Javadoc that repeats the name
    - FORMAT: first sentence = self-contained summary, use @see and {@link}

    **JPA Entities (HIGH priority):**
    - `Source` -- role: represents a documentation source (URL + metadata), architectural context: maps to `sources` table, lifecycle: PENDING -> CRAWLING -> INDEXED
    - `DocumentChunk` -- role: a single indexed chunk of documentation, maps to `document_chunks` table
    - `IngestionState` -- role: tracks incremental crawl state per source
    - `SourceStatus` -- enum values with brief descriptions

    **Repositories (LOW priority, brief):**
    - `SourceRepository`, `DocumentChunkRepository`, `IngestionStateRepository` -- one-line class Javadoc explaining what entity it manages

    **Config classes (MEDIUM):**
    - `EmbeddingConfig` -- documents ONNX model choice, embedding dimensions, PgVectorEmbeddingStore config
    - `GlobalExceptionHandler` -- documents error mapping strategy
    - `Crawl4AiConfig` -- documents REST client configuration for Crawl4AI sidecar

    **Crawl4AI DTOs (LOW, brief since they map external API):**
    - `Crawl4AiClient` -- class-level Javadoc (already has method-level)
    - `CrawlResult`, `Crawl4AiResponse`, `Crawl4AiPageResult`, `Crawl4AiRequest`, `Crawl4AiLink`, `Crawl4AiMarkdown` -- one-line record Javadoc describing purpose

    **AlexandriaApplication (LOW):**
    - Brief class-level Javadoc

    **Integration test consolidation:**
    Move `cleanStore()` @BeforeEach into BaseIntegrationTest:
    ```java
    @Autowired(required = false) EmbeddingStore<TextSegment> embeddingStore;

    @BeforeEach
    void cleanStore() {
        if (embeddingStore != null) {
            embeddingStore.removeAll();
        }
    }
    ```
    Use `required = false` so ITs that don't inject EmbeddingStore (SmokeIntegrationTest, JpaSchemaDriftIT, Crawl4AiClientIT, CrawlServiceIT) are unaffected.

    Remove the duplicate `cleanStore()` from: EmbeddingStoreIT, IngestionServiceIT, PreChunkedImporterIT, PreChunkedImporterRollbackIT.
  </action>
  <verify>
    `./quality.sh test` passes. `./quality.sh integration` passes. Verify no duplicate cleanStore() methods exist in IT classes (grep for "cleanStore" in integrationTest/).
  </verify>
  <done>All 18 classes have Javadoc per documentation rules. cleanStore() consolidated in BaseIntegrationTest. No duplicate cleanStore() in child IT classes.</done>
</task>

<task type="auto">
  <name>Task 2: Harmonize test names to camelCase and perform dead code/import cleanup</name>
  <files>
    src/test/java/dev/alexandria/crawl/UrlNormalizerTest.java
    src/test/java/dev/alexandria/search/SearchRequestTest.java
    src/test/java/dev/alexandria/search/SearchServiceTest.java
    src/integrationTest/java/dev/alexandria/EmbeddingStoreIT.java
    src/integrationTest/java/dev/alexandria/JpaSchemaDriftIT.java
    src/integrationTest/java/dev/alexandria/SmokeIntegrationTest.java
    src/integrationTest/java/dev/alexandria/crawl/Crawl4AiClientIT.java
    src/integrationTest/java/dev/alexandria/crawl/CrawlServiceIT.java
    src/integrationTest/java/dev/alexandria/ingestion/IngestionServiceIT.java
    src/integrationTest/java/dev/alexandria/ingestion/prechunked/PreChunkedImporterIT.java
    src/integrationTest/java/dev/alexandria/ingestion/prechunked/PreChunkedImporterRollbackIT.java
    src/integrationTest/java/dev/alexandria/search/HybridSearchIT.java
  </files>
  <action>
    **Test name harmonization (~46 renames across 11 files):**

    Per user decision: harmonize all test names to **camelCase descriptive** (e.g., `deliveryWithPastDateIsInvalid`). The two files already in camelCase (MarkdownChunkerTest, LanguageDetectorTest) need no changes.

    Rename pattern: `snake_case_name` -> `snakeCaseName`

    Files to process (from research inventory):
    | File | Count | Example: before -> after |
    |------|-------|--------------------------|
    | UrlNormalizerTest | 9 | `normalize_removes_fragment` -> `normalizeRemovesFragment` |
    | SearchRequestTest | 5 | `default_maxResults_is_10` -> `defaultMaxResultsIsTen` |
    | SearchServiceTest | 4 | `search_returns_result...` -> `searchReturnsResult...` |
    | IngestionServiceIT | 4 | `ingest_crawl_result_produces_searchable_chunks` -> `ingestCrawlResultProducesSearchableChunks` |
    | PreChunkedImporterIT | 5 | `import_valid_chunks_makes_them_searchable` -> `importValidChunksMakesThemSearchable` |
    | PreChunkedImporterRollbackIT | 1 | `existing_chunks_preserved_when_embedAll_fails` -> `existingChunksPreservedWhenEmbedAllFails` |
    | HybridSearchIT | 6 | `semantic_search_finds_relevant_chunks_by_meaning` -> `semanticSearchFindsRelevantChunksByMeaning` |
    | EmbeddingStoreIT | 3 | `embedding_model_generates_384_dimension_vector` -> `embeddingModelGenerates384DimensionVector` |
    | JpaSchemaDriftIT | 3 | `source_entity_roundtrips_against_flyway_schema` -> `sourceEntityRoundtripsAgainstFlywaySchema` |
    | Crawl4AiClientIT | 3 | `crawl_returns_markdown_for_valid_url` -> `crawlReturnsMarkdownForValidUrl` |
    | CrawlServiceIT | 3 | `crawlSite_crawls_at_least_one_page` -> `crawlSiteCrawlsAtLeastOnePage` |

    **Dead code + import cleanup:**
    Run through ALL Java files in src/main, src/test, src/integrationTest:
    - Remove unused imports (any import not referenced in the file)
    - Remove any dead code (unreachable methods, unused private fields, commented-out code)
    - Verify no TODO/FIXME comments remain (research found zero, but double-check after all changes)

    **After all renames, verify test counts match:**
    ```bash
    ./quality.sh test        # verify same number of unit tests pass
    ./quality.sh integration # verify same number of IT tests pass
    ```
    Per research pitfall: test count must not change after rename-only operations.
  </action>
  <verify>
    `./quality.sh test` passes with same test count as before renames. `./quality.sh integration` passes with same test count. `grep -r "_[a-z]" --include="*.java" src/test/ src/integrationTest/ | grep "void "` returns no snake_case test method names.
  </verify>
  <done>All ~46 snake_case test names converted to camelCase. No unused imports in any modified file. No dead code. All quality gates pass.</done>
</task>

</tasks>

<verification>
- `./quality.sh all --with-integration` passes all quality gates
- No snake_case test method names remain (grep verification)
- All 18 classes have class-level Javadoc
- No duplicate cleanStore() in integration tests
- No unused imports in modified files
- Test counts unchanged after renames
</verification>

<success_criteria>
Entire codebase has consistent Javadoc, uniform camelCase test naming, consolidated IT infrastructure, and zero dead code/unused imports. All quality gates pass clean.
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-code-quality-consolidation/04.5-05-SUMMARY.md`
</output>

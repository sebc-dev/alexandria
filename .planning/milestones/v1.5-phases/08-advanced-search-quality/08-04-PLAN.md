---
phase: 08-advanced-search-quality
plan: 04
type: execute
wave: 3
depends_on:
  - 08-01
  - 08-02
  - 08-03
files_modified:
  - src/main/java/dev/alexandria/mcp/McpToolService.java
  - src/main/java/dev/alexandria/mcp/TokenBudgetTruncator.java
  - src/main/java/dev/alexandria/crawl/CrawlService.java
  - src/test/java/dev/alexandria/mcp/McpToolServiceTest.java
  - src/test/java/dev/alexandria/mcp/TokenBudgetTruncatorTest.java
autonomous: true
requirements:
  - SRCH-07
  - SRCH-08
  - SRCH-09
  - SRCH-10
  - SRCH-04
  - CHUNK-06

must_haves:
  truths:
    - "search_docs MCP tool accepts filter params: source, sectionPath, version, contentType, minScore, rrfK"
    - "search_docs returns reranking score in each result for Claude Code confidence assessment"
    - "add_source MCP tool accepts optional version parameter that persists on Source entity"
    - "recrawl_source MCP tool accepts optional version parameter and batch-updates chunk metadata on version change"
    - "Empty filter results include explanatory message with available values"
    - "CrawlService passes version and sourceName to IngestionService during ingestion"
    - "Token budget truncator includes rerankScore in formatted output"
  artifacts:
    - path: "src/main/java/dev/alexandria/mcp/McpToolService.java"
      provides: "Extended search_docs, add_source, recrawl_source with filter and version params"
      min_lines: 200
    - path: "src/main/java/dev/alexandria/mcp/TokenBudgetTruncator.java"
      provides: "Search result formatting with reranking score"
    - path: "src/test/java/dev/alexandria/mcp/McpToolServiceTest.java"
      provides: "Unit tests for all new MCP parameters"
      min_lines: 100
  key_links:
    - from: "src/main/java/dev/alexandria/mcp/McpToolService.java"
      to: "SearchService"
      via: "searchDocs passes filter params via SearchRequest"
      pattern: "new SearchRequest.*source.*sectionPath.*version.*rrfK"
    - from: "src/main/java/dev/alexandria/mcp/McpToolService.java"
      to: "Source.setVersion"
      via: "addSource and recrawlSource set version on Source entity"
      pattern: "source\\.setVersion"
    - from: "src/main/java/dev/alexandria/mcp/McpToolService.java"
      to: "DocumentChunkRepository"
      via: "recrawlSource calls batch update metadata on version change"
      pattern: "updateVersionMetadata"
    - from: "src/main/java/dev/alexandria/crawl/CrawlService.java"
      to: "IngestionService.ingestPage"
      via: "passes version and sourceName from Source to ingestPage"
      pattern: "ingestPage.*version.*sourceName"
---

<objective>
Wire all Phase 8 capabilities into the MCP tool layer: extended search_docs with filters and reranking scores, version parameter on add_source/recrawl_source, metadata denormalization during crawl, and empty-filter explanatory messages.

Purpose: This is the integration layer that exposes all Phase 8 improvements to Claude Code via MCP tools. Without this plan, the reranking and filtering infrastructure remains unused.
Output: Extended MCP tools, CrawlService version passthrough, TokenBudgetTruncator with rerank scores, comprehensive unit tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-advanced-search-quality/08-RESEARCH.md
@.planning/phases/08-advanced-search-quality/08-01-SUMMARY.md
@.planning/phases/08-advanced-search-quality/08-02-SUMMARY.md
@.planning/phases/08-advanced-search-quality/08-03-SUMMARY.md
@src/main/java/dev/alexandria/mcp/McpToolService.java
@src/main/java/dev/alexandria/mcp/TokenBudgetTruncator.java
@src/main/java/dev/alexandria/crawl/CrawlService.java
@src/main/java/dev/alexandria/search/SearchRequest.java
@src/main/java/dev/alexandria/search/SearchResult.java
@src/main/java/dev/alexandria/document/DocumentChunkRepository.java
@src/main/java/dev/alexandria/source/Source.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP tool extensions + CrawlService version passthrough</name>
  <files>
    src/main/java/dev/alexandria/mcp/McpToolService.java
    src/main/java/dev/alexandria/mcp/TokenBudgetTruncator.java
    src/main/java/dev/alexandria/crawl/CrawlService.java
  </files>
  <action>
    1. Update `search_docs` in `McpToolService`:
       - Add new `@ToolParam` parameters: `source` (optional, "Filter by source name"), `sectionPath` (optional, "Filter by section path prefix, e.g. 'API Reference'"), `version` (optional, "Filter by version tag, e.g. 'React 19'"), `contentType` (optional, "Filter by content type: PROSE, CODE, or MIXED (all)"), `minScore` (optional, "Minimum reranking confidence score (0.0-1.0). Results below this threshold are excluded."), `rrfK` (optional Integer, "RRF k parameter for reciprocal rank fusion (default 60). Higher values reduce the impact of rank differences.")
       - Per user decision, `rrfK` is exposed as a flat search_docs parameter. Note: per research, rrfK is a store-level config in LangChain4j's PgVectorEmbeddingStore (set at startup, not per-request). Accept the parameter and pass it to SearchRequest for API completeness. Log a debug message if provided noting the value is accepted but applied at store-level configuration only.
       - Build `SearchRequest` with all filter params including rrfK: `new SearchRequest(query, max, source, sectionPath, version, contentType, minScore, rrfK)`
       - When results are empty and any filter is set, build explanatory message:
         - Inject `DocumentChunkRepository` into McpToolService constructor
         - Query available values: `findDistinctVersions()`, `findDistinctSourceNames()`
         - Return message like: "No results for query '%s' with filters [version='React 19']. Available versions: [3.5, React 18]. Available sources: [Spring Docs, React Docs]."
       - When results are non-empty, pass to truncator as usual

    2. Update `TokenBudgetTruncator.formatResult()` to include reranking score:
       - Change format to include `Score: %.3f` line:
         ```
         ## [%d] Source: %s
         Section: %s
         Score: %.3f

         %s

         ---
         ```
       - Use `result.rerankScore()` for the score value

    3. Update `add_source` in `McpToolService`:
       - Add `@ToolParam(description = "Version label for this source (e.g., 'React 19', '3.5')", required = false) String version`
       - After creating Source: `source.setVersion(version)` (before save)

    4. Update `recrawl_source` in `McpToolService`:
       - Add `@ToolParam(description = "Update the version label for this source", required = false) String version`
       - If version is provided and differs from current: update Source entity, save, then batch update chunk metadata via `documentChunkRepository.updateVersionMetadata(source.getUrl(), version)`
       - Do this BEFORE dispatching the crawl so new chunks get the updated version

    5. Update `CrawlService` to pass version and sourceName to IngestionService at ALL call sites:
       - Add `SourceRepository` to CrawlService's constructor (CrawlService receives sourceId but needs the repository to look up version/name)
       - Load the Source entity ONCE at the start of `crawlSite(UUID sourceId, ...)` and cache its version/name locally (avoid repeated DB lookups)
       - **Call site 1 (llms-full.txt):** At line ~78, `ingestionService.ingestPage(discovery.llmsFullContent(), rootUrl, Instant.now().toString())` -- update to use the 5-param overload: `ingestPage(discovery.llmsFullContent(), rootUrl, Instant.now().toString(), source.getVersion(), source.getName())`. Without this fix, llms-full.txt chunks will silently lack version and source_name metadata.
       - **Call site 2 (incremental crawl loop):** In `ingestIncremental()` at line ~227, `ingestionService.ingestPage(markdown, normalizedUrl, Instant.now().toString())` -- update to use the 5-param overload. Pass the cached version/sourceName to `ingestIncremental()` (add parameters to the private method signature).

    6. Update `dispatchCrawl` in McpToolService:
       - No changes needed here -- version is already persisted on Source entity before dispatch, and CrawlService reads it fresh
  </action>
  <verify>
    `./quality.sh test` passes. search_docs accepts all new parameters. add_source/recrawl_source accept version. TokenBudgetTruncator includes reranking score.
  </verify>
  <done>
    search_docs MCP tool accepts source, sectionPath, version, contentType, minScore, rrfK parameters with AND-logic filtering. add_source and recrawl_source accept version parameter. CrawlService denormalizes version+sourceName into chunks during ingestion. Empty filter results return explanatory messages with available values. Token budget output includes reranking score.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for MCP extensions + quality gates</name>
  <files>
    src/test/java/dev/alexandria/mcp/McpToolServiceTest.java
    src/test/java/dev/alexandria/mcp/TokenBudgetTruncatorTest.java
  </files>
  <action>
    1. Add/update tests in `McpToolServiceTest.java`:
       - `searchDocsPassesFilterParamsToSearchRequest()`: call searchDocs with source, sectionPath, version, contentType, verify SearchService.search() receives a SearchRequest with all filter fields set
       - `searchDocsPassesMinScoreToSearchRequest()`: verify minScore forwarded correctly
       - `searchDocsEmptyResultWithFiltersShowsAvailableValues()`: mock empty search results + mock DocumentChunkRepository.findDistinctVersions() returning ["3.5", "React 19"], verify response contains available versions
       - `searchDocsEmptyResultWithoutFiltersShowsPlainMessage()`: when no filters set and no results, just "No results found" without available values
       - `addSourceSetsVersionOnEntity()`: verify source.setVersion() called before save
       - `addSourceWithNullVersionLeavesVersionNull()`: verify no NPE when version not provided
       - `recrawlSourceUpdatesVersionAndBatchUpdatesMetadata()`: when new version differs from current, verify Source saved with new version AND documentChunkRepository.updateVersionMetadata() called
       - `recrawlSourceSameVersionSkipsBatchUpdate()`: when version matches current, no batch update
       - `recrawlSourceNullVersionSkipsBatchUpdate()`: when version param is null, no update

    2. Update `TokenBudgetTruncatorTest.java`:
       - Update existing tests to use SearchResult with rerankScore field
       - `formatResultIncludesRerankScore()`: verify output contains "Score: 0.850" (or similar format)
       - Ensure backward-compatible tests still pass with updated SearchResult constructor

    3. Run full quality gate:
       - `./quality.sh test` -- all unit tests
       - `./quality.sh spotbugs` -- verify no new findings
       - `./quality.sh arch` -- verify no package cycle violations (CrawlService -> SourceRepository is OK since crawl already depends on source via CrawlScope.fromSource)
  </action>
  <verify>
    `./quality.sh test` passes. `./quality.sh spotbugs` passes. `./quality.sh arch` passes. All new MCP parameter tests verify correct wiring.
  </verify>
  <done>
    All MCP tool extensions tested: search_docs filter forwarding, empty filter explanatory messages, add_source/recrawl_source version parameter, batch metadata update on version change. TokenBudgetTruncator includes reranking score. Quality gates clean.
  </done>
</task>

</tasks>

<verification>
- `./quality.sh test` -- all unit tests pass
- `./quality.sh spotbugs` -- no new findings
- `./quality.sh arch` -- no architecture violations
- search_docs accepts: query, maxResults, source, sectionPath, version, contentType, minScore, rrfK
- add_source accepts: version parameter (optional)
- recrawl_source accepts: version parameter (optional), triggers batch metadata update on change
- Empty filter results include available versions and sources in message
- Reranking score visible in search output
- CrawlService passes version + sourceName to ingestPage
</verification>

<success_criteria>
Phase 8 is fully integrated into the MCP tool layer. Claude Code can: search with filters (source, section path, version, content type, rrfK), see reranking confidence scores, tag sources with versions, and trigger recrawls that update version metadata. Empty filter results guide Claude Code with available values. All quality gates pass.
</success_criteria>

<output>
After completion, create `.planning/phases/08-advanced-search-quality/08-04-SUMMARY.md`
</output>
